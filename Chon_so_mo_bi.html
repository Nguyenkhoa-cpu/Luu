<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìø D√ÉY S·ªê THEO KINH D·ªäCH V√Ä TH·∫¶N S·ªê H·ªåC</title>
<style>
    /* Reset v√† Box Sizing ƒë·ªÉ d·ªÖ qu·∫£n l√Ω b·ªë c·ª•c */
    *, *::before, *::after {
        box-sizing: border-box;
    }

    /* ƒê·ªãnh nghƒ©a c√°c bi·∫øn m√†u s·∫Øc (ƒë√£ gi·ªØ nguy√™n v√† s·∫Øp x·∫øp g·ªçn h∆°n) */
    :root {
        --blue: #007bff;
        --blue-dark: #0056b3;
        --grey: #6c757d;
        --grey-dark: #5a6268;
        --cat: #14804a; /* T·ªët */
        --trungbinh: #f39c12; /* Trung b√¨nh */
        --xau: #c0392b; /* X·∫•u */
    }

    /* C√†i ƒë·∫∑t chung cho body */
    body {
        font-family: 'Segoe UI', Tahoma, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 20px;
        font-size: 15px;
        line-height: 1.6; /* TƒÉng line-height cho d·ªÖ ƒë·ªçc */
        color: #333; /* M√†u ch·ªØ m·∫∑c ƒë·ªãnh */
    }

    /* V√πng bao quanh n·ªôi dung ch√≠nh */
    .wrap {
        max-width: 1450px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 8px 16px rgba(0,0,0,.08);
    }

    /* CSS cho ti√™u ƒë·ªÅ m·ªõi */
    .app-header {
        text-align: center;
        margin-bottom: 25px; /* Kho·∫£ng c√°ch d∆∞·ªõi ti√™u ƒë·ªÅ */
    }

    .app-title {
        font-size: 2.2em; /* K√≠ch th∆∞·ªõc ch·ªØ l·ªõn h∆°n cho ti√™u ƒë·ªÅ ch√≠nh */
        color: var(--blue-dark); /* S·ª≠ d·ª•ng m√†u xanh ƒë·∫≠m ƒë√£ ƒë·ªãnh nghƒ©a */
        margin-bottom: 5px; /* Kho·∫£ng c√°ch gi·ªØa ti√™u ƒë·ªÅ v√† ph·ª• ƒë·ªÅ */
        text-transform: uppercase; /* Ch·ªØ in hoa */
        font-weight: 700;
    }

    .app-subtitle {
        font-size: 1.1em; /* K√≠ch th∆∞·ªõc ch·ªØ cho ph·ª• ƒë·ªÅ */
        color: #555;
        font-style: italic; /* Ch·ªØ nghi√™ng */
    }

    /* Thi·∫øt l·∫≠p l∆∞·ªõi chung */
    .grid {
        display: grid;
        gap: 25px;
    }

    /* L∆∞·ªõi h·∫πp cho b·ªë c·ª•c 2 c·ªôt */
    .grid-narrow {
        grid-template-columns: 260px 1fr;
    }

    /* Ki·ªÉu d√°ng form nh·∫≠p li·ªáu */
    .form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* Ki·ªÉu d√°ng nh√£n (label) */
    label {
        font-weight: 600;
        color: #4a6a8a;
        margin-bottom: 5px; /* Th√™m kho·∫£ng c√°ch d∆∞·ªõi label */
        display: block; /* ƒê·∫£m b·∫£o label chi·∫øm d√≤ng ri√™ng */
    }

    /* Ki·ªÉu d√°ng input v√† select */
    input[type="text"], input[type="number"], select {
        width: 100%;
        padding: 10px;
        border: 1px solid #cdd4da;
        border-radius: 6px;
        font-size: 1em;
        line-height: 1.5; /* ƒê·ªìng b·ªô line-height */
    }

    /* Ki·ªÉu d√°ng n√∫t b·∫•m chung */
    .btn {
        padding: 12px 18px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        color: #fff;
        cursor: pointer;
        transition: background-color .2s ease-in-out; /* ƒê·ªïi sang ease-in-out */
        font-size: 1em;
        text-align: center;
        text-decoration: none; /* ƒê·∫£m b·∫£o kh√¥ng c√≥ g·∫°ch ch√¢n n·∫øu l√† th·∫ª a */
        display: inline-block; /* ƒê·ªÉ padding v√† margin ho·∫°t ƒë·ªông ƒë√∫ng */
    }

    /* M√†u n√∫t ch√≠nh */
    .primary { background: var(--blue); }
    .primary:hover { background: var(--blue-dark); }

    /* M√†u n√∫t ph·ª• */
    .grey { background: var(--grey); }
    .grey:hover { background: var(--grey-dark); }

    /* Ki·ªÉu d√°ng thanh tab */
    .tabs {
        display: flex;
        border-bottom: 2px solid #ccc;
        margin-bottom: 20px;
        overflow-x: auto; /* Th√™m cu·ªôn ngang n·∫øu qu√° nhi·ªÅu tab tr√™n m√†n h√¨nh nh·ªè */
        white-space: nowrap; /* NgƒÉn c√°c tab xu·ªëng d√≤ng */
    }

    /* Ki·ªÉu d√°ng c√°c n√∫t tab */
    .tabs button {
        flex: 1; /* Chia ƒë·ªÅu kh√¥ng gian */
        min-width: 150px; /* Chi·ªÅu r·ªông t·ªëi thi·ªÉu cho m·ªói tab */
        background: #f1f1f1;
        padding: 14px 0;
        border: none;
        font-weight: 600;
        cursor: pointer;
        font-size: 1.05em;
        transition: background-color .2s ease-in-out, color .2s ease-in-out;
        border-radius: 8px 8px 0 0; /* Bo tr√≤n g√≥c tr√™n */
        margin-right: 2px; /* Kho·∫£ng c√°ch gi·ªØa c√°c tab */
    }
    .tabs button:last-child {
        margin-right: 0;
    }
    .tabs button:hover { background: #e1e1e1; }
    .tabs button.active {
        background: var(--blue);
        color: #fff;
        border-bottom: 3px solid var(--blue); /* Highlight tab active */
        margin-bottom: -1px; /* K√©o l√™n 1px ƒë·ªÉ che ƒë∆∞·ªùng border c·ªßa .tabs */
    }

    /* ·∫®n c√°c tab m·∫∑c ƒë·ªãnh */
    .tab {
        display: none;
        padding: 15px 0; /* Th√™m padding cho n·ªôi dung tab */
    }

    /* Ki·ªÉu d√°ng b·∫£ng */
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: .95em;
        table-layout: fixed; /* C·ªë ƒë·ªãnh layout b·∫£ng ƒë·ªÉ tr√°nh tr√†n */
    }

    /* Ki·ªÉu d√°ng ti√™u ƒë·ªÅ b·∫£ng v√† √¥ d·ªØ li·ªáu */
    th, td {
        border: 1px solid #e2e8f0;
        padding: 10px 12px;
        text-align: left;
        vertical-align: middle;
        word-break: break-word; /* Ng·∫Øt t·ª´ khi qu√° d√†i */
        overflow-wrap: break-word; /* T∆∞∆°ng th√≠ch t·ªët h∆°n v·ªõi word-break */
    }

    /* M√†u n·ªÅn ti√™u ƒë·ªÅ b·∫£ng */
    th {
        background: var(--blue);
        color: #fff;
        font-weight: 600;
    }

    /* ƒê·ªô r·ªông c·ªôt cho s·ªë th·ª© t·ª± v√† cƒÉn gi·ªØa */
    .w-idx { width: 60px; text-align: center; } /* TƒÉng ƒë·ªô r·ªông ƒë·ªÉ ch·ª©a icon s·ªë khoanh tr√≤n */
    .w-crit { width: 30%; } /* ƒêi·ªÅu ch·ªânh % ƒë·ªÉ linh ho·∫°t h∆°n */
    .w-rate { width: 120px; text-align: center; }
    .w-luan-cu { width: auto; } /* ƒê·ªÉ c·ªôt lu·∫≠n c·ª© t·ª± ƒë·ªông co gi√£n */

    /* M√†u sao ƒë√°nh gi√° */
    .star {
        font-size: 1.3em;
        color: #ccc;
        cursor: pointer;
        transition: color 0.1s ease-in-out;
        margin: 0 1px;
    }
    .star.sel { color: #f1c40f; }

    /* Icon k·∫øt qu·∫£ t·ªët/trung b√¨nh/x·∫•u */
    .icon-good { color: var(--cat); }
    .icon-avg { color: var(--trungbinh); }
    .icon-bad { color: var(--xau); }

    /* Khu v·ª±c hi·ªÉn th·ªã qu·∫ª */
    .que-area {
        display: flex;
        gap: 20px;
        flex-wrap: wrap; /* Cho ph√©p xu·ªëng d√≤ng tr√™n m√†n h√¨nh nh·ªè */
        margin-top: 18px;
    }

    /* H·ªôp ch·ª©a qu·∫ª */
    .que-box {
        flex: 1 1 320px; /* ƒê·∫£m b·∫£o k√≠ch th∆∞·ªõc t·ªëi thi·ªÉu v√† t·ª± co gi√£n */
        background: #f8f8f8;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        overflow-y: auto;
        max-height: 280px; /* TƒÉng chi·ªÅu cao t·ªëi ƒëa m·ªôt ch√∫t n·∫øu c·∫ßn */
        min-width: 280px; /* ƒê·∫£m b·∫£o kh√¥ng qu√° nh·ªè tr√™n m√†n h√¨nh di ƒë·ªông */
    }

    /* Ti√™u ƒë·ªÅ qu·∫ª */
    .que-title {
        text-align: center;
        font-weight: 700;
        color: var(--blue);
        margin-bottom: 10px;
        font-size: 1.1em;
    }

    /* D√≤ng h√†o trong qu·∫ª */
    .hao-line {
        display: flex;
        align-items: center;
        margin: 6px 0;
        height: 26px; /* Gi·ªØ nguy√™n chi·ªÅu cao h√†o */
    }

    /* V√πng hi·ªÉn th·ªã h√¨nh ·∫£nh h√†o */
    .que-line-visual {
        width: 80px;
        flex-shrink: 0; /* NgƒÉn co l·∫°i */
    }

    /* H√†o D∆∞∆°ng (v·∫°ch li·ªÅn) */
    .line-yang {
        width: 100%;
        height: 7px;
        background: #333;
        border-radius: 4px;
    }

    /* H√†o √Çm (v·∫°ch ƒë·ª©t) */
    .line-yin {
        display: flex;
        justify-content: space-between;
    }
    .line-yin > div {
        background: #333;
        width: 45%;
        height: 7px;
        border-radius: 4px;
    }

    /* L·ªõp cho h√†o ƒë·ªông (ƒë√°nh d·∫•u m√†u ƒë·ªè) */
    .hl-bar { background: var(--xau) !important; }

    /* M√†u ch·ªØ cho h√†o ƒë·ªông */
    .hl-text .hao-text-val { color: var(--xau); font-weight: 700; }

    /* Th√¥ng tin h√†o */
    .hao-info {
        font-size: .9em;
        margin-left: 15px;
        white-space: nowrap; /* NgƒÉn xu·ªëng d√≤ng */
        color: #555;
        flex-grow: 1; /* Cho ph√©p chi·∫øm h·∫øt kh√¥ng gian c√≤n l·∫°i */
    }

    /* Nh√£n Th·∫ø/·ª®ng */
    .the-ung-label {
        font-weight: bold;
        color: #fff;
        background: #2c3e50;
        padding: 2px 8px;
        border-radius: 4px;
        margin-left: 12px;
        font-size: 0.8em;
        vertical-align: middle; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
    }

    /* M√†n h√¨nh t·∫£i ·ª©ng d·ª•ng */
    #app-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 99;
        font-size: 1.2em;
        color: var(--blue);
        flex-direction: column; /* ƒê·∫£m b·∫£o text v√† spinner (n·∫øu c√≥) n·∫±m d·ªçc */
        gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa c√°c ph·∫ßn t·ª≠ loading */
    }

    /* N√∫t h√†nh ƒë·ªông (chung cho c√°c tab) */
    .action-buttons {
        display: flex;
        flex-wrap: wrap; /* Cho ph√©p c√°c n√∫t xu·ªëng d√≤ng n·∫øu m√†n h√¨nh h·∫πp */
        gap: 10px;
        margin-bottom: 20px;
    }

    /* Responsive cho m√†n h√¨nh nh·ªè h∆°n 900px */
    @media(max-width: 900px) {
        .grid-narrow { grid-template-columns: 1fr; }
        .form { order: 2; } /* ƒê·∫©y form xu·ªëng d∆∞·ªõi tr√™n di ƒë·ªông */
        .que-box { flex: 1 1 100%; max-height: 200px; } /* ƒê·∫£m b·∫£o qu·∫ª chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
        body { padding: 10px; } /* Gi·∫£m padding t·ªïng th·ªÉ */
        .wrap { padding: 15px; } /* Gi·∫£m padding wrap */
        .tabs button {
            flex: none; /* B·ªè flex:1 ƒë·ªÉ m·ªói n√∫t c√≥ chi·ªÅu r·ªông t·ª± nhi√™n */
            width: auto;
            padding: 10px 12px; /* ƒêi·ªÅu ch·ªânh padding cho ph√π h·ª£p */
            font-size: 0.95em;
        }
        th, td { padding: 8px; } /* Gi·∫£m padding b·∫£ng */
    }

    /* CSS M·ªöI CHO TAB 3 */
    /* Khu v·ª±c ƒëi·ªÅu khi·ªÉn Tab 3 */
    .tab3-controls {
        margin-bottom: 20px;
        padding: 15px;
        background: #e9ecef;
        border-radius: 8px;
    }
    .tab3-controls h4 {
        margin-top: 0;
        color: #34495e;
        border-bottom: 1px solid #ccd;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    /* L∆∞·ªõi cho c√°c t√πy ch·ªçn b·ªô l·ªçc */
    .filter-options {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); /* Gi·∫£m minwidth 1 ch√∫t */
        gap: 10px;
        margin-bottom: 15px;
    }
    /* T·ª´ng m·ª•c trong b·ªô l·ªçc */
    .filter-item {
        display: flex;
        align-items: center;
        background-color: #f5f5f5;
        padding: 8px 12px;
        border-radius: 5px;
        border: 1px solid #e0e0e0;
        transition: background-color 0.2s ease;
    }
    .filter-item:hover {
        background-color: #e8e8e8;
    }
    .filter-item input[type="checkbox"] {
        margin-right: 10px;
        width: auto;
        transform: scale(1.2); /* Ph√≥ng to checkbox m·ªôt ch√∫t */
        cursor: pointer;
    }
    .filter-item label {
        margin-bottom: 0;
        cursor: pointer;
        flex-grow: 1; /* Cho ph√©p label chi·∫øm h·∫øt kh√¥ng gian */
    }

    /* N√∫t h√†nh ƒë·ªông cho b·ªô l·ªçc */
    .filter-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    /* B·∫£ng xem tr∆∞·ªõc b√°o c√°o */
    .report-preview-table th, .report-preview-table td {
        border: 1px solid #ddd;
        padding: 8px;
    }
    .report-preview-table th {
        background-color: #f2f2f2;
        color: #333; /* ƒê·ªïi m√†u ch·ªØ cho d·ªÖ nh√¨n h∆°n */
    }
    .report-preview-table .w-idx { width: 60px; text-align: center; } /* ƒê·ªìng b·ªô v·ªõi w-idx chung */
    .report-preview-table .w-crit { width: 30%; }
    .report-preview-table .w-rate { width: 120px; text-align: center; }

    /* ƒêi·ªÅu ch·ªânh cho s·ªë th·ª© t·ª± v√† cƒÉn ch·ªânh vƒÉn b·∫£n */
    .report-preview-table .tieu-chi-col {
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }
    .report-preview-table .tieu-chi-num {
        font-size: 1.5em;
        line-height: 1;
        flex-shrink: 0;
        padding-right: 5px;
        white-space: nowrap;
        width: 2.8em;
        min-width: 2.8em;
        text-align: center;
        color: var(--blue);
        font-weight: 600;
        background-color: #eaf3ff; /* N·ªÅn nh·∫π cho s·ªë */
        border-radius: 5px;
        padding: 3px 0;
    }
    .report-preview-table .tieu-chi-text {
        flex-grow: 1;
        padding-left: 0;
        text-indent: 0;
    }
    .report-preview-table textarea { /* ƒê·ªïi t·ª´ input[type="text"] sang textarea */
        width: 100%;
        box-sizing: border-box;
        min-height: 60px; /* Chi·ªÅu cao t·ªëi thi·ªÉu cho textarea */
        resize: vertical; /* Ch·ªâ cho ph√©p k√©o gi√£n chi·ªÅu d·ªçc */
        padding: 8px;
        border: 1px solid #cdd4da;
        border-radius: 6px;
        font-size: 0.95em;
        line-height: 1.5;
    }

    /* CSS cho Rating Stars */
    .rating-stars {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
        height: 1.3em;
        margin: auto; /* CƒÉn gi·ªØa nh√≥m sao trong √¥ b·∫£ng */
    }
    .rating-stars .star {
        font-size: 1.3em;
        color: #ccc;
        transition: color 0.1s ease-in-out;
        margin: 0 1px;
    }
    .rating-stars .star.sel { color: #f1c40f; }

    .rating-stars .star-zero {
        font-size: 1.4em;
        color: var(--xau);
        margin-right: 5px;
        cursor: pointer;
        transition: color 0.1s ease-in-out;
    }
    .rating-stars .star-zero.sel {
        color: var(--blue-dark); /* ƒê·ªïi m√†u khi ch·ªçn 0 sao */
    }


    /* Print styles */
    @media print {
    body { background: #fff; padding: 0; margin: 0; font-size: 12px; }
    .wrap { box-shadow: none; border-radius: 0; padding: 0; margin: 0; max-width: none; }
    .tabs, .form, .action-buttons, .tab3-controls, #app-loader, .app-header { display: none !important; }
    .tab { display: block !important; padding: 0 !important; }
    #t3 .action-buttons { display: none !important; }

    table { border-color: #000 !important; table-layout: fixed; }
    th, td { border-color: #000 !important; padding: 6px 8px; word-wrap: break-word; overflow-wrap: break-word; }
    th { background-color: #e0e0e0 !important; color: #000 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }

    /* ƒê·ªô r·ªông c·ªôt cho b·∫£n in */
    th:nth-child(1), td:nth-child(1) { width: 50px; text-align: center; }
    th:nth-child(2), td:nth-child(2) { width: 180px; }
    th:nth-child(3), td:nth-child(3) { width: 90px; text-align: center; }
    th:nth-child(4), td:nth-child(4) { width: auto; }

    .tieu-chi-num-print {
        font-size: 1.2em;
        line-height: 1;
        display: inline-block;
        margin-right: 3px;
        color: #007bff;
        font-weight: bold;
        background-color: #eaf3ff;
        border-radius: 3px;
        padding: 1px 0;
        min-width: 1.8em;
        text-align: center;
        -webkit-print-color-adjust: exact; color-adjust: exact;
    }
    .print-rating-stars {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 1.3em;
        -webkit-print-color-adjust: exact; color-adjust: exact;
    }
    .print-rating-stars .star-zero-print {
        font-size: 1.4em;
        color: #c0392b;
        -webkit-print-color-adjust: exact; color-adjust: exact;
    }
    .print-rating-stars .star-print {
        font-size: 1.3em;
        color: #f1c40f;
        -webkit-print-color-adjust: exact; color-adjust: exact;
    }
    .print-rating-stars .star-empty-print {
        font-size: 1.3em;
        color: #ccc;
        -webkit-print-color-adjust: exact; color-adjust: exact;
    }

    /* C√°c ph·∫ßn details/summary trong lu·∫≠n gi·∫£i (style cho b·∫£n in) */
    details.dropdown-item {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 8px 12px;
        margin-bottom: 10px;
        background-color: #f9f9f9;
        page-break-inside: avoid;
    }
    details.dropdown-item[open] {
        background-color: #eef6ff;
        border-color: #007bff;
    }
    details.dropdown-item summary {
        font-weight: 600;
        color: #333;
        padding-left: 15px;
        font-size: 0.9em;
    }
    details.dropdown-item summary::before {
        content: '‚ñ∂';
        color: #666;
        font-size: 0.8em;
        left: 0;
        top: 2px;
        position: absolute;
    }
    details.dropdown-item .dropdown-content {
        padding-top: 5px;
        padding-left: 8px;
        border-left: 1px solid #bbb;
        color: #444;
        font-size: 0.85em;
    }

    /* --- C·∫§U H√åNH FOOTER CHO T·∫§T C·∫¢ C√ÅC TRANG IN (ƒê√É C·∫¨P NH·∫¨T) --- */
    @page {
        margin: 1cm; /* Gi·ªØ margin trang */
        /* ƒê·∫∑t n·ªôi dung footer tr·ª±c ti·∫øp v√†o g√≥c d∆∞·ªõi b√™n tr√°i c·ªßa m·ªói trang */
        @bottom-left {
            content: "Nguy·ªÖn Khoa - Ch·ªçn d√£y s·ªë theo Kinh d·ªãch, B√°t t·ª±, Th·∫ßn s·ªë h·ªçc ph∆∞∆°ng ƒë√¥ng, NƒÉng l∆∞·ª£ng s·ªë";
            font-size: 0.7em;
            color: #555;
            text-align: left; /* CƒÉn l·ªÅ tr√°i */
            /* C√°c thu·ªôc t√≠nh n√†y c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông tr√™n m·ªçi tr√¨nh duy·ªát/h·ªá ƒëi·ªÅu h√†nh cho content trong @page */
            -webkit-print-color-adjust: exact; 
            color-adjust: exact;
        }
        /* X√≥a t·∫•t c·∫£ c√°c n·ªôi dung m·∫∑c ƒë·ªãnh kh√°c ·ªü c√°c g√≥c ƒë·ªÉ tr√°nh xung ƒë·ªôt */
        @bottom-right { content: ""; } 
        @top-right { content: ""; }
        @top-left { content: ""; }
    }

    /* ƒê·∫£m b·∫£o kh√¥ng c√≥ ph·∫ßn t·ª≠ .custom-print-footer trong HTML khi in ƒë·ªÉ tr√°nh tr√πng l·∫∑p */
    .custom-print-footer {
        display: none !important; 
    }
}

</style>
</head>
<body>
<div style="text-align:center; margin-top: 20px;">
  <h1 style="color:#0056cc; font-size:32px; font-weight:bold; text-transform:uppercase; margin-bottom: 5px;">
    CH·ªåN D√ÉY S·ªê THEO KINH D·ªäCH & TH·∫¶N S·ªê H·ªåC
  </h1>
  <p style="color:#0056cc; font-size:18px; font-weight:bold; margin-top: 0;">
    Nguy·ªÖn Khoa
  </p>
</div>

<div id="app-loader"><span>üîÆ ƒêang n·∫°p D·ªØ li·ªáu...</span></div>

<div class="wrap" id="main-content" style="display:none;">
    <div class="tabs">
        <button class="tab-btn active" data-tab="t1">1. T·ªïng Quan & H√¨nh Qu·∫ª</button>
        <button class="tab-btn" data-tab="t2">2. Lu·∫≠n Gi·∫£i Chi Ti·∫øt</button>
        <button class="tab-btn" data-tab="t3">3. T·ªïng H·ª£p & ƒê√°nh Gi√°</button>
    </div>
       
    

    <div id="t1" class="tab" style="display:block;">
        <div class="grid grid-narrow">
            <div class="form">
                <h3><label>üìù Th√¥ng tin gia ch·ªß</label></h3>
                <div><label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label><input id="phone" type="text" value="0919134368" maxlength="12"></div>
                <div><label for="year">NƒÉm sinh (D∆∞∆°ng l·ªãch):</label><input id="year" type="number" value="1983"></div>
                <div><label for="sex">Gi·ªõi t√≠nh:</label><select id="sex"><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option></select></div>
                <div><label for="dung">D·ª•ng th·∫ßn:</label><input id="dung" type="text" value="H·ªèa, Th·ªï"></div>
                <button class="btn primary" onclick="run()">‚ú® Lu·∫≠n Gi·∫£i ‚ú®</button>
                <button class="btn grey" onclick="location.reload()">üîÑ L√†m M·ªõi</button>
            </div>
            <div>
                <table id="tblSum"></table>
                <div class="que-area">
                    <div class="que-box"><p class="que-title" id="queGocTitle">üîÆ Qu·∫ª G·ªëc</p><div id="hexMain"></div></div>
                    <div class="que-box"><p class="que-title" id="queBienTitle">üåÄ Qu·∫ª Bi·∫øn</p><div id="hexChange"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="t2" class="tab">
        <table>
            <thead><tr><th class="w-idx">#</th><th class="w-crit">Ti√™u Ch√≠ Lu·∫≠n Gi·∫£i</th><th>K·∫øt Qu·∫£ Ph√¢n T√≠ch</th></tr></thead>
            <tbody id="tblDetail"></tbody>
        </table>
    </div>

    <div id="t3" class="tab">
        <div class="tab3-controls">
            <h4>Ch·ªçn c√°c ti√™u ch√≠ ƒë·ªÉ hi·ªÉn th·ªã trong b√°o c√°o:</h4>
            <div id="filterOptions" class="filter-options">
            </div>
            <div class="filter-actions">
                <button class="btn primary" onclick="selectAllCriteria()">Ch·ªçn t·∫•t c·∫£</button>
                <button class="btn grey" onclick="deselectAllCriteria()">B·ªè ch·ªçn t·∫•t c·∫£</button>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn primary" onclick="exportToGoogleSheet()">üìÑ Xu·∫•t sang Google Sheet</button>
            <button class="btn grey" onclick="exportToPDF()">üìï Xu·∫•t sang PDF</button>
            <button class="btn primary" onclick="copyReportToClipboard()">üìã Copy B√°o C√°o</button>
            <button class="btn grey" onclick="printReport()">üñ®Ô∏è In B√°o C√°o</button>
        </div>

        <h4>B√°o c√°o xem tr∆∞·ªõc:</h4>
        <div id="reportPreview">
            <table class="report-preview-table">
                <thead><tr><th class="w-idx">#</th><th class="w-crit">Ti√™u Ch√≠</th><th class="w-rate">Ch·∫•m ƒêi·ªÉm</th><th>Lu·∫≠n C·ª© (c√≥ th·ªÉ s·ª≠a)</th></tr></thead>
                <tbody id="tblFinal">
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
// --- KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C ---
let ALL_DATA = {}; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·ªØ t·∫•t c·∫£ d·ªØ li·ªáu phong th·ªßy t·ª´ backend
let ALL_QUE_INFO = {}; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u th√¥ng tin chi ti·∫øt c·ªßa Qu·∫ª G·ªëc v√† Qu·∫ª Bi·∫øn
let FINAL_RESULTS = []; // M·∫£ng ch·ª©a k·∫øt qu·∫£ lu·∫≠n gi·∫£i cu·ªëi c√πng cho b√°o c√°o
let selectedCriteria = {}; // ƒê·ªëi t∆∞·ª£ng l∆∞u tr·ªØ tr·∫°ng th√°i ch·ªçn/b·ªè ch·ªçn c√°c ti√™u ch√≠ trong Tab 3

// M·∫£ng ƒë·ªãnh nghƒ©a danh s√°ch c√°c ti√™u ch√≠ lu·∫≠n gi·∫£i
const TIEU_CHI_LIST = [
    "D√£y s·ªë qu·∫ª d·ªãch g·ªëc v√† √Ω nghƒ©a", // Ti√™u ch√≠ 1
    "D√£y s·ªë qu·∫ª d·ªãch bi·∫øn v√† √Ω nghƒ©a", // Ti√™u ch√≠ 2
    "H√†o Th·∫ø", // Ti√™u ch√≠ 3
    "H√†o ƒê·ªông", // Ti√™u ch√≠ 4
    "Qu·∫ª Th∆∞·ª£ng so v·ªõi Cung Phi", // Ti√™u ch√≠ 5
    "Qu·∫ª H·∫° so v·ªõi Cung Phi", // Ti√™u ch√≠ 6
    "Ng≈© h√†nh d√£y s·ªë so v·ªõi cung phi", // Ti√™u ch√≠ 7
    "Qu·∫ª g·ªëc ph·ªëi Cung Phi (Du Ni√™n)", // Ti√™u ch√≠ 8
    "Qu·∫ª th∆∞·ª£ng so v·ªõi D·ª•ng th·∫ßn", // Ti√™u ch√≠ 9
    "Qu·∫ª h·∫° so v·ªõi D·ª•ng th·∫ßn", // Ti√™u ch√≠ 10
    "2 s·ªë cu·ªëi t·∫°o th√†nh qu·∫ª d·ªãch", // Ti√™u ch√≠ 11
    "C√°c c·∫∑p s·ªë h√†nh tr√¨nh", // Ti√™u ch√≠ 12
    "C√¢n b·∫±ng √¢m d∆∞∆°ng", // Ti√™u ch√≠ 13
    "D√£y s·ªë theo ƒë∆∞∆°ng v·∫≠n", // Ti√™u ch√≠ 14
    "C√°c c·∫∑p c√°t hung theo th·∫ßn s·ªë & nƒÉng l∆∞·ª£ng", // Ti√™u ch√≠ 15
    "T·ªï h·ª£p ƒë·∫∑c bi·ªát 3 s·ªë cu·ªëi", // Ti√™u ch√≠ 16
    "C√°c t·ªï h·ª£p s·ªë ƒë·∫∑c bi·ªát", // Ti√™u ch√≠ 17
    "Ghi ch√∫", // Ti√™u ch√≠ 18 ( s·ª≠a th√†nh ghi ch√∫)
];

// M·∫£ng ch·ª©a c√°c k√Ω t·ª± s·ªë khoanh tr√≤n Unicode ƒë·ªÉ hi·ªÉn th·ªã s·ªë th·ª© t·ª± ƒë·∫πp h∆°n
const NUMBER_CIRCLED = ['‚ì™', '‚ë†', '‚ë°', '‚ë¢', '‚ë£', '‚ë§', '‚ë•', '‚ë¶', '‚ëß', '‚ë®', '‚ë©', '‚ë™', '‚ë´', '‚ë¨', '‚ë≠', '‚ëÆ', '‚ëØ', '‚ë∞', '‚ë±', '‚ë≤', '‚ë≥'];

/**
 * @function getCircledNumber
 * @description Chuy·ªÉn ƒë·ªïi s·ªë nguy√™n th√†nh k√Ω t·ª± s·ªë khoanh tr√≤n Unicode.
 */
function getCircledNumber(num) {
    if (num >= 0 && num < NUMBER_CIRCLED.length) {
        return NUMBER_CIRCLED[num];
    }
    return num.toString();
}

// ƒê·ªãnh nghƒ©a m√£ nh·ªã ph√¢n cho c√°c qu·∫ª ƒë∆°n
const bin = {"1":"111", "2":"011", "3":"101", "4":"001", "5":"110", "6":"010", "7":"100", "8":"000"};
// M·∫£ng 10 Thi√™n Can
const stems = ['Gi√°p', '·∫§t', 'B√≠nh', 'ƒêinh', 'M·∫≠u', 'K·ª∑', 'Canh', 'T√¢n', 'Nh√¢m', 'Qu√Ω'];
// M·∫£ng 12 ƒê·ªãa Chi
const branches = ['T√Ω', 'S·ª≠u', 'D·∫ßn', 'M√£o', 'Th√¨n', 'T·ªµ', 'Ng·ªç', 'M√πi', 'Th√¢n', 'D·∫≠u', 'Tu·∫•t', 'H·ª£i'];
// √Ånh x·∫° Cung Phi v·ªõi Ng≈© h√†nh
const cungPhiNguHanhMap = { 'C√†n':'Kim', 'ƒêo√†i':'Kim', 'Kh·∫£m':'Th·ªßy', 'Ly':'H·ªèa', 'Ch·∫•n':'M·ªôc', 'T·ªën':'M·ªôc', 'C·∫•n':'Th·ªï', 'Kh√¥n':'Th·ªï' };
// √Ånh x·∫° s·ªë qu·∫ª H·∫≠u Thi√™n v·ªõi t√™n qu·∫ª
const soQueHauThienMap = {1:'Kh·∫£m', 2:'Kh√¥n', 3:'Ch·∫•n', 4:'T·ªën', 6:'C√†n', 7:'ƒêo√†i', 8:'C·∫•n', 9:'Ly'};
// √Ånh x·∫° qu·∫ª Ti√™n Thi√™n v·ªõi t√™n qu·∫ª v√† ng≈© h√†nh
const tienThienMap = { 1: { ten: 'C√†n', hanh: 'Kim' }, 2: { ten: 'ƒêo√†i', hanh: 'Kim' }, 3: { ten: 'Ly', hanh: 'H·ªèa' }, 4: { ten: 'Ch·∫•n', hanh: 'M·ªôc' }, 5: { ten: 'T·ªën', hanh: 'M·ªôc' }, 6: { ten: 'Kh·∫£m', hanh: 'Th·ªßy' }, 7: { ten: 'C·∫•n', hanh: 'Th·ªï' }, 8: { ten: 'Kh√¥n', hanh: 'Th·ªï' } };
// Quan h·ªá t∆∞∆°ng sinh, t∆∞∆°ng kh·∫Øc c·ªßa Ng≈© h√†nh
const nguHanhRelations = { 'Kim': { sinh: 'Th·ªßy', khac: 'M·ªôc' }, 'Th·ªßy': { sinh: 'M·ªôc', khac: 'H·ªèa' }, 'M·ªôc': { sinh: 'H·ªèa', khac: 'Th·ªï' }, 'H·ªèa': { sinh: 'Th·ªï', khac: 'Kim' }, 'Th·ªï': { sinh: 'Kim', khac: 'Th·ªßy' } };

// --- C√ÅC H√ÄM TI·ªÜN √çCH ---

// H√ÄM normalizeName ƒê√É ƒê∆Ø·ª¢C D√ÅN L·∫†I ƒê·ªÇ KH·∫ÆC PH·ª§C L·ªñI
function normalizeName(name) {
  if (!name) return '';
  const trimmedLower = name.toString().trim().toLowerCase();
  const nameMap = {
    'c√†n': 'C√†n', 'can': 'C√†n', 'thi√™n': 'C√†n',
    'ƒëo√†i': 'ƒêo√†i', 'doai': 'ƒêo√†i', 'tr·∫°ch': 'ƒêo√†i',
    'ly': 'Ly', 'h·ªèa': 'Ly',
    'ch·∫•n': 'Ch·∫•n', 'chan': 'Ch·∫•n', 'l√¥i': 'Ch·∫•n',
    't·ªën': 'T·ªën', 'ton': 'T·ªën', 'phong': 'T·ªën',
    'kh·∫£m': 'Kh·∫£m', 'kham': 'Kh·∫£m', 'th·ªßy': 'Kh·∫£m',
    'c·∫•n': 'C·∫•n', 'son': 'C·∫•n', 's∆°n': 'C·∫•n',
    'kh√¥n': 'Kh√¥n', 'khon': 'Kh√¥n', 'ƒë·ªãa': 'Kh√¥n'
  };
  return nameMap[trimmedLower] || name.toString().trim();
}

/**
 * @function sumMod
 * @description T√≠nh t·ªïng c√°c ph·∫ßn t·ª≠ trong m·∫£ng v√† l·∫•y s·ªë d∆∞ theo modulo m.
 */
function sumMod(arr, m) { return arr.reduce((a, b) => a + b, 0) % m || m; }

/**
 * @function canChi
 * @description Chuy·ªÉn ƒë·ªïi nƒÉm d∆∞∆°ng l·ªãch sang Thi√™n Can ƒê·ªãa Chi.
 */
function canChi(y) { return `${stems[(y-4)%10]} ${branches[(y-4)%12]}`; }

/**
 * @function CUNG_PHI
 * @description T√≠nh Cung Phi d·ª±a tr√™n nƒÉm sinh d∆∞∆°ng l·ªãch v√† gi·ªõi t√≠nh.
 */
function CUNG_PHI(year, sex) {
    let sum = (year % 100).toString().split('').reduce((a, b) => a + +b, 0);
    while (sum > 9) sum = sum.toString().split('').reduce((a, b) => a + +b, 0);
    let num = sex === 'Nam' ? 10 - sum : 5 + sum;
    while (num > 9) num = num.toString().split('').reduce((a, b) => a + +b, 0);
    if (num === 5) num = sex === 'Nam' ? 2 : 8; // Quy t·∫Øc ƒë·∫∑c bi·ªát cho s·ªë 5
    return soQueHauThienMap[num] || '?';
}

/**
 * @function short
 * @description C·∫Øt chu·ªói t·∫°i d·∫•u ch·∫•m ho·∫∑c d·∫•u ph·∫©y ƒë·ªÉ l·∫•y ph·∫ßn ƒë·∫ßu.
 */
function short(t) { return t ? t.split(/[.Ôºå]/)[0] : ''; }

/**
 * @function createExpandableSection
 * @description T·∫°o m·ªôt ph·∫ßn c√≥ th·ªÉ m·ªü r·ªông/thu g·ªçn (details/summary) ƒë·ªÉ hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt.
 */
function createExpandableSection(summaryText, detailContent) {
    if (!detailContent || detailContent.trim() === '') {
        return summaryText; // N·∫øu kh√¥ng c√≥ n·ªôi dung chi ti·∫øt, ch·ªâ hi·ªÉn th·ªã t√≥m t·∫Øt
    }
    const formattedDetailContent = detailContent.replace(/\n/g, '<br>');
    return `
        <details class="dropdown-item">
            <summary>${summaryText}</summary>
            <div class="dropdown-content">${formattedDetailContent}</div>
        </details>
    `;
}

/**
 * @function soSanhNguHanh
 * @description So s√°nh m·ªëi quan h·ªá Ng≈© h√†nh gi·ªØa hai y·∫øu t·ªë (t∆∞∆°ng sinh, t∆∞∆°ng kh·∫Øc, t·ª∑ h√≤a).
 */
function soSanhNguHanh(tenNguon, hanhNguon, tenDich, hanhDich) {
    const relations = nguHanhRelations;
    if (!hanhNguon || !hanhDich) return { ket_qua: "Trung b√¨nh", luan_giai: `Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c Ng≈© h√†nh.` };

    if (hanhNguon === hanhDich) return { ket_qua: "Trung b√¨nh", luan_giai: `${tenNguon} <b>(${hanhNguon})</b> so v·ªõi ${tenDich} <b>(${hanhDich})</b> l√† T·ª∑ h√≤a (b√¨nh th∆∞·ªùng).` };
    if (relations[hanhNguon]?.sinh === hanhDich) return { ket_qua: "T·ªët", luan_giai: `${tenNguon} <b>(${hanhNguon})</b> T∆∞∆°ng Sinh cho ${tenDich} <b>(${hanhDich})</b>. R·∫•t t·ªët.` };
    if (relations[hanhNguon]?.khac === hanhDich) return { ket_qua: "X·∫•u", luan_giai: `${tenNguon} <b>(${hanhNguon})</b> T∆∞∆°ng Kh·∫Øc ${tenDich} <b>(${hanhDich})</b>. R·∫•t x·∫•u.` };
    if (relations[hanhDich]?.sinh === hanhNguon) return { ket_qua: "Trung b√¨nh", luan_giai: `${tenNguon} <b>(${hanhNguon})</b> l√†m ${tenDich} <b>(${hanhDich})</b> b·ªã Sinh Xu·∫•t. B√¨nh th∆∞·ªùng.` };
    if (relations[hanhDich]?.khac === hanhNguon) return { ket_qua: "T·ªët", luan_giai: `${tenDich} <b>(${hanhDich})</b> kh·∫Øc ƒë∆∞·ª£c ${tenNguon} <b>(${hanhNguon})</b>. T·ªët.` };
    return { ket_qua: "Trung b√¨nh", luan_giai: "Kh√¥ng x√°c ƒë·ªãnh m·ªëi quan h·ªá Ng≈© h√†nh." };
}

/**
 * @function luanAmDuong
 * @description Lu·∫≠n gi·∫£i s·ª± c√¢n b·∫±ng √Çm D∆∞∆°ng c·ªßa d√£y s·ªë ƒëi·ªán tho·∫°i so v·ªõi nƒÉm sinh.
 */
function luanAmDuong(sdt, namSinh) {
    const isNamDuong = parseInt(namSinh) % 2 === 0;
    const tuoiAmDuongText = isNamDuong ? 'D∆∞∆°ng' : '√Çm';
    let soDuong = 0; // S·ªë l·∫ª
    let soAm = 0; // S·ªë ch·∫µn
    for (const digit of sdt) {
        if (!isNaN(parseInt(digit))) { // ƒê·∫£m b·∫£o l√† s·ªë
            if (parseInt(digit) % 2 === 0) soAm++;
            else soDuong++;
        }
    }

    if (soDuong === soAm) {
        return { ket_qua: "T·ªët", luan_giai: `D√£y s·ªë c√≥ ${soDuong} s·ªë D∆∞∆°ng (l·∫ª) v√† ${soAm} s·ªë √Çm (ch·∫µn). √Çm D∆∞∆°ng c√¢n b·∫±ng ho√†n h·∫£o. R·∫•t t·ªët.` };
    }

    let ketLuan = `D√£y s·ªë c√≥ ${soDuong} s·ªë D∆∞∆°ng v√† ${soAm} s·ªë √Çm. Tu·ªïi c·ªßa s·∫øp l√† tu·ªïi <b>${tuoiAmDuongText}</b>, `;
    let ketQua = "X·∫•u";

    if (isNamDuong) { // Tu·ªïi D∆∞∆°ng (c·∫ßn √Çm ƒë·ªÉ c√¢n b·∫±ng)
        ketLuan += `c·∫ßn nhi·ªÅu s·ªë √Çm (ch·∫µn) h∆°n ƒë·ªÉ c√¢n b·∫±ng.`;
        if (soAm > soDuong) {
            ketQua = "T·ªët";
            ketLuan += ` D√£y s·ªë n√†y nghi√™ng v·ªÅ √Çm, r·∫•t t·ªët.`;
        } else {
            ketLuan += ` D√£y s·ªë n√†y l·∫°i nghi√™ng v·ªÅ D∆∞∆°ng, ch∆∞a t·ªët.`;
        }
    } else { // Tu·ªïi √Çm (c·∫ßn D∆∞∆°ng ƒë·ªÉ c√¢n b·∫±ng)
        ketLuan += `c·∫ßn nhi·ªÅu s·ªë D∆∞∆°ng (l·∫ª) h∆°n ƒë·ªÉ c√¢n b·∫±ng.`;
        if (soDuong > soAm) {
            ketQua = "T·ªët";
            ketLuan += ` D√£y s·ªë n√†y nghi√™ng v·ªÅ D∆∞∆°ng, r·∫•t t·ªët.`;
        } else {
            ketLuan += ` D√£y s·ªë n√†y l·∫°i nghi√™ng v·ªÅ √Çm, ch∆∞a t·ªët.`;
        }
    }
    return { ket_qua: ketQua, luan_giai: ketLuan };
}

/**
 * @function luanDuongVan
 * @description Lu·∫≠n gi·∫£i d√£y s·ªë theo quan ni·ªám s·ªë c√°t/hung (t·ªët/x·∫•u) d·ª±a tr√™n c√°c s·ªë ƒë∆°n l·∫ª.
 */
function luanDuongVan(sdt) {
    const soCat = ['1', '6', '8', '9']; // C√°c s·ªë ƒë∆∞·ª£c coi l√† C√°t
    let demCat = 0;
    let demHung = 0;
    for (const digit of sdt) {
        if (isNaN(parseInt(digit))) continue; // B·ªè qua n·∫øu kh√¥ng ph·∫£i s·ªë
        if (soCat.includes(digit)) demCat++;
        else demHung++;
    }
    const luanGiai = `D√£y s·ªë c√≥ <b>${demCat}</b> s·ªë C√°t (1, 6, 8, 9) v√† <b>${demHung}</b> s·ªë Hung (0, 2, 3, 4, 5, 7).`;
    const ketQua = demCat > demHung ? "T·ªët" : (demHung > demCat ? "X·∫•u" : "Trung b√¨nh");
    return { ket_qua: ketQua, luan_giai: luanGiai };
}

/**
 * @function nguHanhDay_JS
 * @description T√≠nh Ng≈© h√†nh c·ªßa m·ªôt d√£y s·ªë theo c√¥ng th·ª©c ƒë·∫∑c bi·ªát.
 */
function nguHanhDay_JS(day_so) {
    if (!day_so) return null;
    const s = day_so.toString().replace(/\D/g, ''); // Ch·ªâ gi·ªØ l·∫°i s·ªë
    if (s.length === 0) return null;

    let tong_rut_gon = [...s].reduce((sum, digit) => sum + parseInt(digit, 10), 0);
    while (tong_rut_gon > 9) {
        tong_rut_gon = [...tong_rut_gon.toString()].reduce((sum, digit) => sum + parseInt(digit, 10), 0);
    }

    let so_cung = 11 - tong_rut_gon;
    if (so_cung >= 10) { // N·∫øu l·ªõn h∆°n ho·∫∑c b·∫±ng 10, ti·∫øp t·ª•c r√∫t g·ªçn (vd: 10 -> 1)
        so_cung = [...so_cung.toString()].reduce((sum, digit) => sum + parseInt(digit, 10), 0);
    }

    // B·∫£ng tra H·∫≠u Thi√™n B√°t Qu√°i
    const soQueHauThienMapLocal = {1:'Kh·∫£m', 2:'Kh√¥n', 3:'Ch·∫•n', 4:'T·ªën', 5:'Th·ªï', 6:'C√†n', 7:'ƒêo√†i', 8:'C·∫•n', 9:'Ly'};
    return cungPhiNguHanhMap[soQueHauThienMapLocal[so_cung]] || null;
}

/**
 * @function luanThanSo
 * @description Lu·∫≠n gi·∫£i c√°c c·∫∑p s·ªë trong d√£y s·ªë theo Th·∫ßn S·ªë h·ªçc v√† nƒÉng l∆∞·ª£ng B√°t Tinh.
 */
function luanThanSo(sdt, mapNangLuong) {
    const ketQuaPhanTich = [];
    let demCat = 0;
    let demHung = 0;

    for (let i = 0; i < sdt.length - 1; i++) {
        const capSo = sdt.substring(i, i + 2);
        // ∆Øu ti√™n tra c·ª©u c·∫∑p s·ªë xu√¥i, n·∫øu kh√¥ng c√≥ th√¨ tra c·ª©u c·∫∑p s·ªë ƒë·∫£o ng∆∞·ª£c
        const nangLuong = mapNangLuong[capSo] || mapNangLuong[capSo.split('').reverse().join('')];

        if (nangLuong) {
            ketQuaPhanTich.push({ cap: capSo, ...nangLuong });
            if (nangLuong.loai === 'T·ªët') demCat++;
            else demHung++;
        }
    }

    if (ketQuaPhanTich.length === 0) {
        return { ket_qua: "Trung b√¨nh", luan_giai: "Kh√¥ng c√≥ c·∫∑p nƒÉng l∆∞·ª£ng n√†o ƒë∆∞·ª£c x√°c ƒë·ªãnh."};
    }

    const ketQuaTong = demCat > demHung ? 'T·ªët' : (demHung > demCat ? 'X·∫•u' : 'Trung b√¨nh');
    let html = `<p><b>T·ªïng quan:</b> D√£y s·ªë c√≥ ${demCat} c·∫∑p nƒÉng l∆∞·ª£ng C√°t v√† ${demHung} c·∫∑p nƒÉng l∆∞·ª£ng Hung. T·ªïng th·ªÉ nghi√™ng v·ªÅ <b>${ketQuaTong}</b>.</p>`;

    html += `<div style="margin-top: 15px;">`;
    ketQuaPhanTich.forEach(item => {
        const icon = item.loai === 'T·ªët' ? '‚≠ê'.repeat(item.manh) : '‚ùå'.repeat(item.manh);
        const iconClass = item.loai === 'T·ªët' ? 'icon-good' : 'icon-bad';
        const summaryText = `C·∫∑p <b>${item.cap}</b>: ${item.ten} (${item.manh} sao ${item.loai}) ${icon} >> ${item.y_nghia_van_tat}`;
        const detailContent = item.y_nghia_chi_tiet;

        html += createExpandableSection(summaryText, detailContent);
    });
    html += `</div>`;

    return { ket_qua: ketQuaTong, luan_giai: html };
}

/**
 * @function capKhongLap_JS
 * @description L·∫•y 3 s·ªë cu·ªëi c·ªßa d√£y s·ªë, x·ª≠ l√Ω tr∆∞·ªùng h·ª£p c√°c s·ªë cu·ªëi l·∫∑p l·∫°i.
 */
function capKhongLap_JS(s) {
    if (!s) return "";
    const str = s.toString().replace(/\D/g, ''); // Ch·ªâ gi·ªØ l·∫°i s·ªë
    const len = str.length;
    if (len < 3) return str; // N·∫øu √≠t h∆°n 3 k√Ω t·ª± th√¨ tr·∫£ v·ªÅ nguy√™n b·∫£n

    let lastThree = str.slice(-3);
    // Ki·ªÉm tra xem 3 k√Ω t·ª± cu·ªëi c√≥ ph·∫£i l√† 3 k√Ω t·ª± gi·ªëng nhau kh√¥ng (v√≠ d·ª•: "888")
    if (lastThree[0] === lastThree[1] && lastThree[1] === lastThree[2]) {
        // N·∫øu c√≥, l·∫•y 3 k√Ω t·ª± tr∆∞·ªõc ƒë√≥
        if (len >= 6) { // N·∫øu ƒë·ªô d√†i ƒë·ªß 6 k√Ω t·ª± tr·ªü l√™n ƒë·ªÉ l·∫•y 3 s·ªë tr∆∞·ªõc ƒë√≥
             return str.slice(-6, -3); // L·∫•y 3 s·ªë t·ª´ v·ªã tr√≠ -6 ƒë·∫øn -3 (tr∆∞·ªõc 3 s·ªë cu·ªëi l·∫∑p)
        } else if (len >= 3) { // N·∫øu kh√¥ng ƒë·ªß 6, nh∆∞ng ƒë·ªß 3, th√¨ v·∫´n l√† 3 s·ªë cu·ªëi
            return str.slice(0,3); // L·∫•y 3 s·ªë ƒë·∫ßu ti√™n
        }
    }
    return lastThree; // Tr·∫£ v·ªÅ 3 s·ªë cu·ªëi b√¨nh th∆∞·ªùng
}

/**
 * @function luanToHopDacBiet
 * @description Tr√≠ch xu·∫•t c√°c b·ªô 3 k√Ω t·ª± li√™n ti·∫øp t·ª´ cu·ªëi d√£y s·ªë v·ªÅ ƒë·∫ßu, lo·∫°i b·ªè b·ªô b·∫Øt ƒë·∫ßu b·∫±ng '0', v√† tr·∫£ v·ªÅ c√°c key duy nh·∫•t.
 */
function luanToHopDacBiet(sdt, mapToHop) {
    const extractedCombos = new Set();
    const cleanedSdt = sdt.replace(/[^0-9]/g, '');

    if (cleanedSdt.length < 3) {
        return [];
    }

    // Tr√≠ch xu·∫•t c√°c b·ªô 3 k√Ω t·ª± t·ª´ cu·ªëi d√£y v·ªÅ ƒë·∫ßu d√£y
    for (let i = cleanedSdt.length - 3; i >= 0; i--) {
        const combo = cleanedSdt.substring(i, i + 3);
        if (combo[0] !== '0') { // Ki·ªÉm tra n·∫øu b·ªô 3 n√†y kh√¥ng b·∫Øt ƒë·∫ßu b·∫±ng '0'
            if (mapToHop.hasOwnProperty(combo)) {
                extractedCombos.add(combo);
            }
        }
    }

    // Chuy·ªÉn Set th√†nh m·∫£ng, v√† s·∫Øp x·∫øp l·∫°i theo th·ª© t·ª± xu·∫•t hi·ªán trong sdt g·ªëc
    const sortedCombos = Array.from(extractedCombos).sort((a, b) => {
        const indexA = cleanedSdt.indexOf(a);
        const indexB = cleanedSdt.indexOf(b);
        return indexA - indexB;
    });

    return sortedCombos;
}

// --- C√ÅC H√ÄM HI·ªÇN TH·ªä ---
/**
 * @function veQue
 * @description V·∫Ω h√¨nh ·∫£nh qu·∫ª (h√†o li·ªÅn/ƒë·ª©t) v√† hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt c·ªßa t·ª´ng h√†o.
 */
function veQue(mahoa, haoDong, isBienQue, linesDetail, theHao, ungHao) {
    let html = "";
    for (let i = 0; i < 6; i++) {
        const bit = mahoa[i];
        const currentHao = 6 - i; // H√†o t·ª´ 6 xu·ªëng 1
        const isHaoDong = currentHao === haoDong;
        const barClass = isHaoDong ? ' hl-bar' : '';

        const lineVisualHTML = bit === '1' ?
            `<div class="line-yang ${barClass}"></div>` :
            `<div class="line-yin"><div class="${barClass}"></div><div class="${barClass}"></div></div>`;

        let theUngLabel = "";
        if (!isBienQue) { // Ch·ªâ hi·ªÉn th·ªã Th·∫ø/·ª®ng cho qu·∫ª g·ªëc
            if (currentHao === parseInt(theHao, 10)) {
                theUngLabel = `<span class="the-ung-label">Th·∫ø</span>`;
            } else if (currentHao === parseInt(ungHao, 10)) {
                theUngLabel = `<span class="the-ung-label">·ª®ng</span>`;
            }
        }

        // ƒê·∫£m b·∫£o linesDetail[i] t·ªìn t·∫°i tr∆∞·ªõc khi truy c·∫≠p
        const haoDetailText = linesDetail && linesDetail[i] ? linesDetail[i] : "";

        html += `
            <div class="hao-line">
                <div class="que-line-visual">${lineVisualHTML}</div>
                <div class="hao-info ${isHaoDong ? 'hl-text' : ''}">
                    <span class="hao-text-val">H√†o ${currentHao}: ${haoDetailText}</span>
                    ${theUngLabel}
                </div>
            </div>
        `;
    }
    return html;
}

/**
 * @function buildSum
 * @description Hi·ªÉn th·ªã th√¥ng tin t·ªïng quan c·ªßa gia ch·ªß v√† k·∫øt qu·∫£ qu·∫ª tr√™n Tab 1.
 */
function buildSum(o) {
    document.getElementById('tblSum').innerHTML = `
        <tbody>
            ${Object.entries(o).map(([k, v]) => `
                <tr>
                    <td style="width:140px;"><b>${k}</b></td>
                    <td>${v}</td>
                </tr>
            `).join('')}
        </tbody>
    `;
}

/**
 * @function buildDetail
 * @description X√¢y d·ª±ng v√† hi·ªÉn th·ªã b·∫£ng chi ti·∫øt lu·∫≠n gi·∫£i tr√™n Tab 2.
 */
function buildDetail(data) {
    const tbody = document.getElementById('tblDetail');
    tbody.innerHTML = data.map((item, index) => {
        let icon = item.ket_qua === 'T·ªët' ? '‚úÖ' : (item.ket_qua === 'X·∫•u' ? '‚ùå' : 'üî∂');
        let iconClass = item.ket_qua === 'T·ªët' ? 'icon-good' : (item.ket_qua === 'X·∫•u' ? 'icon-bad' : 'icon-avg');
        // S·ª≠ d·ª•ng createExpandableSection ƒë·ªÉ b·ªçc n·ªôi dung lu·∫≠n gi·∫£i
        return `
            <tr>
                <td class="w-idx">${index + 1}</td>
                <td><b>${item.tieu_chi}</b></td>
                <td><span class="${iconClass}" style="font-size: 1.2em;">${icon}</span> ${item.luan_giai}</td>
            </tr>
        `;
    }).join('');
}

/**
 * @function updateRating
 * @description C·∫≠p nh·∫≠t ƒëi·ªÉm ch·∫•m c·ªßa m·ªôt ti√™u ch√≠ c·ª• th·ªÉ trong b√°o c√°o cu·ªëi c√πng (Tab 3).
 */
function updateRating(index, rating) {
    // L·ªçc ra c√°c k·∫øt qu·∫£ ƒëang ƒë∆∞·ª£c hi·ªÉn th·ªã tr√™n Tab 3
    const filteredResults = FINAL_RESULTS.filter(
        item => selectedCriteria && selectedCriteria[item.tieu_chi]
    );
    if (!filteredResults || index >= filteredResults.length) return;

    // T√¨m ti√™u ch√≠ g·ªëc trong FINAL_RESULTS (kh√¥ng b·ªã l·ªçc)
    const tieuChiToUpdate = filteredResults[index].tieu_chi;
    const originalItemIndex = FINAL_RESULTS.findIndex(
        item => item.tieu_chi === tieuChiToUpdate
    );

    if (originalItemIndex !== -1) {
        FINAL_RESULTS[originalItemIndex].cham_diem = rating;
    }
    renderTab3Report(); // Render l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán
}

/**
 * @function updateLuanCu
 * @description C·∫≠p nh·∫≠t n·ªôi dung lu·∫≠n c·ª© cho m·ªôt ti√™u ch√≠ trong b√°o c√°o cu·ªëi c√πng (Tab 3).
 */
function updateLuanCu(index, text) {
    const filteredResults = FINAL_RESULTS.filter(item => selectedCriteria?.[item.tieu_chi]);
    const itemToUpdate = filteredResults?.[index];
    if (itemToUpdate) {
        const originalIndex = FINAL_RESULTS.findIndex(item => item.tieu_chi === itemToUpdate.tieu_chi);
        if (originalIndex !== -1) {
            FINAL_RESULTS[originalIndex].luan_cu = text;
        }
    }
}


// --- H√ÄM M·ªöI CHO TAB 3 ---
/**
 * @function renderTab3Filters
 * @description Hi·ªÉn th·ªã c√°c t√πy ch·ªçn l·ªçc ti√™u ch√≠ trong Tab 3.
 */
function renderTab3Filters() {
    const filterOptionsDiv = document.getElementById('filterOptions');
    filterOptionsDiv.innerHTML = '';

    // ƒê·∫£m b·∫£o t·∫•t c·∫£ c√°c ti√™u ch√≠ c√≥ s·∫µn trong FINAL_RESULTS ƒë·ªÅu c√≥ trong selectedCriteria m·∫∑c ƒë·ªãnh l√† true
    FINAL_RESULTS.forEach(item => {
        if (selectedCriteria[item.tieu_chi] === undefined) {
            selectedCriteria[item.tieu_chi] = true;
        }
    });

    TIEU_CHI_LIST.forEach(tieuChiName => {
        // Ch·ªâ hi·ªÉn th·ªã checkbox cho c√°c ti√™u ch√≠ c√≥ k·∫øt qu·∫£ trong FINAL_RESULTS
        const hasResult = FINAL_RESULTS.some(item => item.tieu_chi === tieuChiName);
        if (hasResult) {
            const div = document.createElement('div');
            div.className = 'filter-item';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            // T·∫°o ID duy nh·∫•t, lo·∫°i b·ªè k√Ω t·ª± kh√¥ng h·ª£p l·ªá
            checkbox.id = `filter-${tieuChiName.replace(/\s/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}`;
            checkbox.checked = selectedCriteria[tieuChiName];
            checkbox.onchange = () => {
                selectedCriteria[tieuChiName] = checkbox.checked;
                renderTab3Report(); // Render l·∫°i b√°o c√°o khi thay ƒë·ªïi l·ªçc
            };
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = tieuChiName;
            div.appendChild(checkbox);
            div.appendChild(label);
            filterOptionsDiv.appendChild(div);
        }
    });
    renderTab3Report(); // G·ªçi ƒë·ªÉ render b√°o c√°o ban ƒë·∫ßu sau khi t·∫°o l·ªçc
}

/**
 * @function selectAllCriteria
 * @description Ch·ªçn t·∫•t c·∫£ c√°c ti√™u ch√≠ l·ªçc trong Tab 3.
 */
function selectAllCriteria() {
    FINAL_RESULTS.forEach(item => {
        selectedCriteria[item.tieu_chi] = true;
    });
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i checkbox tr√™n giao di·ªán
    TIEU_CHI_LIST.forEach(tieuChiName => {
        const checkbox = document.getElementById(`filter-${tieuChiName.replace(/\s/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    renderTab3Report();
}

/**
 * @function deselectAllCriteria
 * @description B·ªè ch·ªçn t·∫•t c·∫£ c√°c ti√™u ch√≠ l·ªçc trong Tab 3.
 */
function deselectAllCriteria() {
    FINAL_RESULTS.forEach(item => {
        selectedCriteria[item.tieu_chi] = false;
    });
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i checkbox tr√™n giao di·ªán
    TIEU_CHI_LIST.forEach(tieuChiName => {
        const checkbox = document.getElementById(`filter-${tieuChiName.replace(/\s/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}`);
        if (checkbox) {
            checkbox.checked = false;
        }
    });
    renderTab3Report();
}

/**
 * @function renderTab3Report
 * @description Hi·ªÉn th·ªã b√°o c√°o xem tr∆∞·ªõc v√† cho ph√©p ch·ªânh s·ª≠a trong Tab 3.
 */
function renderTab3Report() {
    const tbody = document.getElementById('tblFinal');
    // L·ªçc c√°c k·∫øt qu·∫£ d·ª±a tr√™n selectedCriteria
    const filteredResults = FINAL_RESULTS.filter(item => selectedCriteria?.[item.tieu_chi]);

    tbody.innerHTML = filteredResults.map((item, index) => {
        // Lo·∫°i b·ªè c√°c th·∫ª HTML ƒë·ªÉ l·∫•y vƒÉn b·∫£n thu·∫ßn t√∫y t·ª´ lu·∫≠n c·ª©
        const luanCuText = typeof item.luan_cu === 'string' ? item.luan_cu.replace(/<[^>]*>?/gm, '') : '';
        let ratingHtml = '';

        // N√∫t cho 0 sao (bi·ªÉu t∆∞·ª£ng üö´)
        ratingHtml += `<span class="star star-zero ${item.cham_diem === 0 ? 'sel' : ''}" data-rating="0" data-index="${index}">üö´</span>`;

        // T·∫°o c√°c ng√¥i sao t·ª´ 1 ƒë·∫øn 5
        for (let i = 1; i <= 5; i++) {
            ratingHtml += `<span class="star ${item.cham_diem >= i && item.cham_diem !== 0 ? 'sel' : ''}" data-rating="${i}" data-index="${index}">‚òÖ</span>`;
        }

        const displayIndex = getCircledNumber(index + 1) + '‚úÖ'; // Th√™m icon check cho ƒë·∫πp

        return `
            <tr>
                <td class="w-idx"><span class="tieu-chi-num">${displayIndex}</span></td>
                <td><span class="tieu-chi-text"><b>${item.tieu_chi}</b></span></td>
                <td class="w-rate" style="text-align: center;">
                    <div class="rating-stars">
                        ${ratingHtml}
                    </div>
                </td>
                <td><textarea rows="3" onchange="updateLuanCu(${index}, this.value)">${luanCuText}</textarea></td>
            </tr>
        `;
    }).join('');

    // G·∫Øn l·∫°i s·ª± ki·ªán click cho c√°c ng√¥i sao sau khi innerHTML ƒë∆∞·ª£c c·∫≠p nh·∫≠t
    tbody.querySelectorAll('.rating-stars .star, .rating-stars .star-zero').forEach(element => {
        element.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            const index = parseInt(this.dataset.index);
            updateRating(index, rating);
        });
    });

    // G·∫Øn l·∫°i s·ª± ki·ªán onchange cho textarea
    tbody.querySelectorAll('textarea').forEach((textarea, idx) => {
        textarea.onchange = (e) => {
            const currentItemInFiltered = filteredResults?.[idx];
            if (currentItemInFiltered) {
                const originalIndexInFinalResults = FINAL_RESULTS.findIndex(item => item.tieu_chi === currentItemInFiltered.tieu_chi);
                if (originalIndexInFinalResults !== -1) {
                    FINAL_RESULTS[originalIndexInFinalResults].luan_cu = e.target.value;
                }
            }
        };
    });
}

/**
 * @function exportToGoogleSheet
 * @description Xu·∫•t d·ªØ li·ªáu b√°o c√°o sang Google Sheet th√¥ng qua Apps Script.
 */
function exportToGoogleSheet() {
    // L·∫•y th√¥ng tin t·ªïng quan t·ª´ Tab 1
    const sdtValue = document.getElementById('phone').value.replace(/\D/g, ''); // ƒê·∫£m b·∫£o ch·ªâ l·∫•y s·ªë
    const yearValue = document.getElementById('year').value;
    const sexValue = document.getElementById('sex').value;
    const dungValue = document.getElementById('dung').value;
    const cungPhiValue = CUNG_PHI(yearValue, sexValue);
    const menhNapAmValue = ALL_DATA.napAm?.[canChi(yearValue)]?.name || 'Kh√¥ng r√µ';

    // L·∫•y th√¥ng tin Qu·∫ª G·ªëc v√† Qu·∫ª Bi·∫øn t·ª´ bi·∫øn ALL_QUE_INFO ƒë√£ l∆∞u khi ch·∫°y run()
    const queGocText = ALL_QUE_INFO.G ? `${ALL_QUE_INFO.G.ten_que} ‚Äì ${short(ALL_QUE_INFO.G.y_nghia)}` : 'N/A';
    const haoDongText = `H√†o ${ALL_QUE_INFO.hao_dong_num || 'N/A'}`;
    const queBienText = ALL_QUE_INFO.B ? `${ALL_QUE_INFO.B.ten_que} ‚Äì ${short(ALL_QUE_INFO.B.y_nghia)}` : 'N/A';

    const infoData = {
        'S·ªë ƒëi·ªán tho·∫°i': sdtValue,
        'NƒÉm sinh': `${yearValue} (${canChi(yearValue)})`,
        'Gi·ªõi t√≠nh': sexValue,
        'D·ª•ng th·∫ßn': dungValue,
        'Cung Phi': cungPhiValue,
        'M·ªánh (N·∫°p √¢m)': menhNapAmValue,
        'Qu·∫ª G·ªëc': queGocText,
        'H√†o ƒë·ªông': haoDongText,
        'Qu·∫ª Bi·∫øn': queBienText
    };

    const dataToSend = {
        info: infoData,
        details: FINAL_RESULTS.filter(item => selectedCriteria?.[item.tieu_chi]).map(item => ({
            tieu_chi: item.tieu_chi,
            cham_diem: item.cham_diem,
            luan_cu: typeof item.luan_cu === 'string' ? item.luan_cu.replace(/<[^>]*>?/gm, '').trim() : '' // Lo·∫°i b·ªè HTML tag
        }))
    };

    // S·∫øp D√ÅN URL ·ª®NG D·ª§NG WEB C·ª¶A APPS SCRIPT V√ÄO ƒê√ÇY
    // ƒê√¢y l√† URL c·ªßa Apps Script backend (c√°i s·∫øp ƒë√£ tri·ªÉn khai d∆∞·ªõi d·∫°ng ·ª©ng d·ª•ng web)
    const SCRIPT_URL = 'YOUR_APPS_SCRIPT_WEB_APP_URL';

    if (SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL' || SCRIPT_URL === '') {
        alert('Vui l√≤ng thi·∫øt l·∫≠p URL Apps Script cho ch·ª©c nƒÉng "Xu·∫•t sang Google Sheet"!');
        return;
    }

    fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(dataToSend)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c xu·∫•t sang Google Sheet th√†nh c√¥ng!');
        } else {
            alert('C√≥ l·ªói x·∫£y ra khi xu·∫•t sang Google Sheet: ' + data.message);
            console.error('Apps Script Error:', data.message);
        }
    })
    .catch((error) => {
        alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Google Sheet. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† thi·∫øt l·∫≠p Apps Script.');
        console.error('Fetch Error:', error);
    });
}

/**
 * @function exportToPDF
 * @description Ch·ª©c nƒÉng xu·∫•t b√°o c√°o sang ƒë·ªãnh d·∫°ng PDF (hi·ªán t·∫°i chuy·ªÉn h∆∞·ªõng sang in).
 */
function exportToPDF() {
    alert('Ch·ª©c nƒÉng "Xu·∫•t sang PDF" s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn sau!');
    printReport(); // T·∫°m th·ªùi g·ªçi h√†m in b√°o c√°o
}

/**
 * @function copyReportToClipboard
 * @description Copy to√†n b·ªô n·ªôi dung b√°o c√°o v√†o clipboard d∆∞·ªõi d·∫°ng vƒÉn b·∫£n thu·∫ßn t√∫y.
 */
function copyReportToClipboard() {
    // L·∫•y th√¥ng tin t·ª´ Tab 1
    const sdtValue = document.getElementById('phone').value;
    const yearValue = document.getElementById('year').value;
    const sexValue = document.getElementById('sex').value;
    const dungValue = document.getElementById('dung').value;
    const cungPhiValue = CUNG_PHI(yearValue, sexValue);
    const menhNapAmValue = ALL_DATA.napAm?.[canChi(yearValue)]?.name || 'Kh√¥ng r√µ';

    // X√¢y d·ª±ng n·ªôi dung vƒÉn b·∫£n thu·∫ßn t√∫y ƒë∆∞·ª£c cƒÉn ch·ªânh theo th·ª•t l·ªÅ
    let textContent = `D√ÉY S·ªê THEO KINH D·ªäCH V√Ä TH·∫¶N S·ªê H·ªåC\n\n`;
    textContent += `Th√¥ng tin gia ch·ªß:\n`;
    textContent += `    S·ªë ƒëi·ªán tho·∫°i: ${sdtValue}\n`;
    textContent += `    NƒÉm sinh: ${yearValue} (${canChi(yearValue)}) - Gi·ªõi t√≠nh: ${sexValue}\n`;
    textContent += `    D·ª•ng th·∫ßn: ${dungValue} - Cung Phi: ${cungPhiValue} - M·ªánh (N·∫°p √¢m): ${menhNapAmValue}\n\n`;

    textContent += `B√°o c√°o chi ti·∫øt:\n`;

    const filteredResults = FINAL_RESULTS.filter(item => selectedCriteria?.[item.tieu_chi]);
    filteredResults.forEach((item, index) => {
        const displayIndex = getCircledNumber(index + 1); // Ch·ªâ l·∫•y s·ªë khoanh tr√≤n, kh√¥ng c√≥ ‚úÖ
        const luanCuText = typeof item.luan_cu === 'string' ? item.luan_cu.replace(/<[^>]*>?/gm, '').trim() : '';

        let scoreDisplay;
        if (item.cham_diem === 0) {
            scoreDisplay = 'üö´';
        } else {
            scoreDisplay = '‚òÖ'.repeat(item.cham_diem) + '‚òÜ'.repeat(5 - item.cham_diem);
        }

        const indent = '    '; // 4 kho·∫£ng tr·∫Øng ƒë·ªÉ th·ª•t v√†o
        textContent += `\n${indent}${displayIndex}‚úÖ ${item.tieu_chi}:\n`;
        textContent += `${indent}  Ch·∫•m ƒêi·ªÉm: ${scoreDisplay}\n`;
        textContent += `${indent}  Lu·∫≠n C·ª©: ${luanCuText}\n`;
    });

    textContent += `\nNguy·ªÖn Khoa - Ch·ªçn d√£y s·ªë theo Kinh d·ªãch, B√°t t·ª±, Th·∫ßn s·ªë h·ªçc ph∆∞∆°ng ƒë√¥ng, NƒÉng l∆∞·ª£ng s·ªë\n`;

    // S·ª≠ d·ª•ng Clipboard API ƒë·ªÉ copy
    navigator.clipboard.writeText(textContent)
        .then(() => {
            alert('ƒê√£ copy b√°o c√°o v√†o clipboard! Vui l√≤ng d√°n v√†o Zalo/Facebook.');
        })
        .catch(err => {
            console.error('L·ªói khi copy: ', err);
            // Fallback cho tr√¨nh duy·ªát c≈© ho·∫∑c l·ªói
            const textarea = document.createElement('textarea');
            textarea.value = textContent;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('ƒê√£ copy b√°o c√°o v√†o clipboard (fallback)! Vui l√≤ng ch·ªçn v√† copy th·ªß c√¥ng:\n\n' + textContent);
            } catch (execErr) {
                alert('Kh√¥ng th·ªÉ copy b√°o c√°o t·ª± ƒë·ªông. Vui l√≤ng ch·ªçn v√† copy th·ªß c√¥ng:\n\n' + textContent);
            }
            document.body.removeChild(textarea);
        });
}

/**
 * @function printReport
 * @description In b√°o c√°o hi·ªán t·∫°i.
 */
function printReport() {
    // L·∫•y th√¥ng tin t·ª´ Tab 1
    const sdtValue = document.getElementById('phone').value;
    const yearValue = document.getElementById('year').value;
    const sexValue = document.getElementById('sex').value;
    const dungValue = document.getElementById('dung').value;
    const cungPhiValue = CUNG_PHI(yearValue, sexValue);
    const menhNapAmValue = ALL_DATA.napAm?.[canChi(yearValue)]?.name || 'Kh√¥ng r√µ';

    // X√¢y d·ª±ng to√†n b·ªô n·ªôi dung HTML cho c·ª≠a s·ªï in
    let printHtmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>D√£y s·ªë theo kinh d·ªãch v√† th·∫ßn s·ªë h·ªçc</title>
            <meta charset="UTF-8">
            <style>
                /* CSS d√†nh ri√™ng cho b·∫£n in - ƒê√£ t·ªëi ∆∞u h√≥a v√† gi·ªØ trong m·ªôt kh·ªëi */
                @page { margin: 1cm; @bottom-right { content: ""; } @bottom-left { content: ""; } @top-right { content: ""; } @top-left { content: ""; } }
                html, body { margin: 0; padding: 0; font-family: sans-serif; font-size: 14px; line-height: 1.5; color: #333; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; table-layout: fixed; }
                th, td { border: 1px solid #000; padding: 8px; text-align: left; vertical-align: top; word-wrap: break-word; overflow-wrap: break-word; }
                th { background-color: #f2f2f2; }
                h3, p { margin: 0; padding: 0; }
                .custom-print-header { text-align: center; margin-bottom: 15px; }
                .custom-print-footer { text-align: right; margin-top: 30px; font-style: italic; font-size: 0.9em; }

                /* ƒê·ªô r·ªông c·ªôt cho in ·∫•n */
                th:nth-child(1), td:nth-child(1) { width: 50px; text-align: center; } /* # */
                th:nth-child(2), td:nth-child(2) { width: 180px; } /* Ti√™u Ch√≠ */
                th:nth-child(3), td:nth-child(3) { width: 90px; text-align: center; } /* Ch·∫•m ƒêi·ªÉm */
                th:nth-child(4), td:nth-child(4) { width: auto; } /* Lu·∫≠n C·ª© */

                .tieu-chi-num-print {
                    font-size: 1.2em;
                    line-height: 1;
                    display: inline-block;
                    margin-right: 3px;
                    color: #007bff; /* M√†u xanh cho s·ªë th·ª© t·ª± khi in */
                    font-weight: bold;
                    background-color: #eaf3ff;
                    border-radius: 3px;
                    padding: 1px 0;
                    min-width: 1.8em;
                    text-align: center;
                    -webkit-print-color-adjust: exact; color-adjust: exact;
                }
                .print-rating-stars {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 1.3em;
                    -webkit-print-color-adjust: exact; color-adjust: exact;
                }
                .print-rating-stars .star-zero-print {
                    font-size: 1.4em;
                    color: #c0392b;
                    -webkit-print-color-adjust: exact; color-adjust: exact;
                }
                .print-rating-stars .star-print {
                    font-size: 1.3em;
                    color: #f1c40f;
                    -webkit-print-color-adjust: exact; color-adjust: exact;
                }
                .print-rating-stars .star-empty-print {
                    font-size: 1.3em;
                    color: #ccc;
                    -webkit-print-color-adjust: exact; color-adjust: exact;
                }
                details.dropdown-item {
                    margin-bottom: 10px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    padding: 8px 12px;
                    background-color: #f9f9f9;
                    page-break-inside: avoid; /* Tr√°nh ng·∫Øt trang gi·ªØa details */
                }
                details.dropdown-item[open] {
                    background-color: #eef6ff;
                    border-color: #007bff;
                }
                details.dropdown-item summary {
                    cursor: pointer;
                    font-weight: 600;
                    color: #2c3e50;
                    list-style: none; /* ·∫®n d·∫•u m≈©i t√™n m·∫∑c ƒë·ªãnh */
                    position: relative;
                    padding-left: 20px;
                }
                details.dropdown-item summary::before {
                    content: '‚ñ∂';
                    position: absolute;
                    left: 0;
                    top: 3px;
                    font-size: 1em;
                    color: #007bff;
                    transition: transform 0.2s ease;
                }
                details.dropdown-item[open] summary::before {
                    content: '‚ñº';
                }
                details.dropdown-item .dropdown-content {
                    padding-top: 8px;
                    padding-left: 10px;
                    border-left: 2px solid #007bff;
                    color: #444;
                    font-size: 0.95em;
                }
            </style>
        </head>
        <body>
            <div class="custom-print-header">
                <h3>D√ÉY S√î THEO KINH D·ªäCH V√Ä TH·∫¶N S·ªê H·ªåC</h3>
                <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${sdtValue}</p>
                <p><strong>NƒÉm sinh:</strong> ${yearValue} (${canChi(yearValue)}) - <strong>Gi·ªõi t√≠nh:</strong> ${sexValue}</p>
                <p><strong>D·ª•ng th·∫ßn:</strong> ${dungValue} - <strong>Cung Phi:</strong> ${cungPhiValue} - <strong>M·ªánh (N·∫°p √¢m):</strong> ${menhNapAmValue}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ti√™u Ch√≠</th>
                        <th>Ch·∫•m ƒêi·ªÉm</th>
                        <th>Lu·∫≠n C·ª©</th>
                    </tr>
                </thead>
                <tbody>
    `;

    const filteredResultsForPrint = FINAL_RESULTS.filter(item => selectedCriteria?.[item.tieu_chi]);
    filteredResultsForPrint.forEach((item, index) => {
        const displayIndex = getCircledNumber(index + 1);
        // Lo·∫°i b·ªè HTML tags t·ª´ lu·∫≠n c·ª© khi in
        const luanCuText = typeof item.luan_cu === 'string' ? item.luan_cu.replace(/<[^>]*>?/gm, '').trim() : '';

        let starsHtml = '';
        if (item.cham_diem === 0) {
            starsHtml = `<span class="star-zero-print">üö´</span>`;
        } else {
            for (let i = 1; i <= 5; i++) {
                starsHtml += `<span class="star-print">${i <= item.cham_diem ? '‚òÖ' : '‚òÜ'}</span>`;
            }
        }

        printHtmlContent += `
                    <tr>
                        <td><span class="tieu-chi-num-print">${displayIndex}</span>‚úÖ</td>
                        <td>${item.tieu_chi}</td>
                        <td><div class="print-rating-stars">${starsHtml}</div></td>
                        <td>${luanCuText}</td>
                    </tr>
        `;
    });

    printHtmlContent += `
                </tbody>
            </table>
            <div class="custom-print-footer">
                Nguy·ªÖn Khoa - Ch·ªçn d√£y s·ªë theo Kinh d·ªãch, B√°t t·ª±, Th·∫ßn s·ªë h·ªçc ph∆∞∆°ng ƒë√¥ng, NƒÉng l∆∞·ª£ng s·ªë
            </div>
        </body>
        </html>
    `;

    const printWindow = window.open('', '_blank', 'height=600,width=800,scrollbars=yes');
    if (printWindow) {
        printWindow.document.open();
        printWindow.document.write(printHtmlContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    } else {
        alert("Tr√¨nh duy·ªát ch·∫∑n popup. Vui l√≤ng cho ph√©p popup ƒë·ªÉ in b√°o c√°o.");
    }
}


// --- H√ÄM CH√çNH ---
/**
 * @function run
 * @description H√†m ch√≠nh th·ª±c hi·ªán to√†n b·ªô qu√° tr√¨nh lu·∫≠n gi·∫£i phong th·ªßy d√£y s·ªë.
 * Thu th·∫≠p d·ªØ li·ªáu, t√≠nh to√°n qu·∫ª, lu·∫≠n gi·∫£i c√°c ti√™u ch√≠ v√† hi·ªÉn th·ªã k·∫øt qu·∫£.
 */
function run() {
    console.clear(); // L√†m s·∫°ch console m·ªói khi ch·∫°y ƒë·ªÉ d·ªÖ debug
    try {
        const sdt = document.getElementById('phone').value.replace(/\D/g, '');
        const y = +document.getElementById('year').value || 0;
        const sex = document.getElementById('sex').value;
        const dung = document.getElementById('dung').value;

        if (!sdt || !y || sdt.length < 3) return alert('Vui l√≤ng nh·∫≠p ƒë·ªß SƒêT (√≠t nh·∫•t 3 s·ªë) v√† NƒÉm sinh!');

        // T√≠nh to√°n qu·∫ª Th∆∞·ª£ng, H·∫° v√† H√†o ƒë·ªông
        const qT_num = sumMod([...sdt.slice(0, Math.floor(sdt.length / 2))].map(Number), 8);
        const qH_num = sumMod([...sdt.slice(Math.floor(sdt.length / 2))].map(Number), 8);
        const hao_dong = sumMod([...sdt].map(Number), 6);

        // L·∫•y th√¥ng tin qu·∫ª g·ªëc t·ª´ d·ªØ li·ªáu
        const codeG = bin[qT_num] + bin[qH_num];
        const G = ALL_DATA.data64[codeG];
        if (!G) return alert(`Kh√¥ng c√≥ d·ªØ li·ªáu Qu·∫ª G·ªëc cho m√£: ${codeG}`);

        // T√≠nh to√°n qu·∫ª Bi·∫øn (b·∫±ng c√°ch ƒë·∫£o h√†o ƒë·ªông)
        const codeB_arr = codeG.split('');
        codeB_arr[6 - hao_dong] = codeB_arr[6 - hao_dong] === '1' ? '0' : '1';
        const codeB_str = codeB_arr.join('');
        const B = ALL_DATA.data64[codeB_str] || { ten_que: '?', y_nghia: 'N/A', cung_goc: '?', lines_detail: Array(6).fill(''), muc_do: 'Trung b√¨nh', y_nghia_chi_tiet: '' };

        // L∆∞u th√¥ng tin qu·∫ª v√†o bi·∫øn to√†n c·ª•c ƒë·ªÉ s·ª≠ d·ª•ng cho c√°c h√†m kh√°c
        ALL_QUE_INFO = {
            G: G,
            B: B,
            hao_dong_num: hao_dong
        };

        const cungPhi = CUNG_PHI(y, sex);
        document.getElementById('queGocTitle').innerHTML = `üîÆ Qu·∫ª G·ªëc (H·ªç ${G.cung_goc})`;
        document.getElementById('queBienTitle').innerHTML = `üåÄ Qu·∫ª Bi·∫øn (H·ªç ${B.cung_goc})`;
        buildSum({
            'SƒêT': sdt,
            'NƒÉm sinh': `${y} (${canChi(y)})`,
            'Gi·ªõi t√≠nh': sex,
            'D·ª•ng th·∫ßn': dung,
            'Cung Phi': cungPhi,
            'M·ªánh (N·∫°p √¢m)': (ALL_DATA.napAm?.[canChi(y)]?.name || 'Kh√¥ng r√µ'),
            'Qu·∫ª G·ªëc': `${G.ten_que} ‚Äì ${short(G.y_nghia)}`,
            'H√†o ƒë·ªông': `H√†o ${hao_dong}`,
            'Qu·∫ª Bi·∫øn': `${B.ten_que} ‚Äì ${short(B.y_nghia)}`
        });
        document.getElementById('hexMain').innerHTML = veQue(codeG, hao_dong, false, G.lines_detail, G.the_hao, G.ung_hao);
        document.getElementById('hexChange').innerHTML = veQue(codeB_str, hao_dong, true, B.lines_detail, 0, 0); // theHao, ungHao kh√¥ng √°p d·ª•ng cho qu·∫ª bi·∫øn

        let detailResults = [];

        // --- B·∫Øt ƒë·∫ßu lu·∫≠n gi·∫£i c√°c ti√™u ch√≠ chi ti·∫øt ---
        // Ti√™u ch√≠ 1: D√£y s·ªë qu·∫ª d·ªãch g·ªëc v√† √Ω nghƒ©a
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[0], ket_qua: G.muc_do, luan_giai: createExpandableSection(`<b>${G.ten_que} (${G.muc_do || 'TB'})</b> >> ${G.y_nghia}`, G.y_nghia_chi_tiet) });
        // Ti√™u ch√≠ 2: D√£y s·ªë qu·∫ª d·ªãch bi·∫øn v√† √Ω nghƒ©a
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[1], ket_qua: B.muc_do, luan_giai: createExpandableSection(`<b>${B.ten_que} (${B.muc_do || 'TB'})</b> >> ${B.y_nghia}`, B.y_nghia_chi_tiet) });
        // Ti√™u ch√≠ 3: H√†o Th·∫ø
        const lucThanTheTraCuu = ALL_DATA.lucThan[G.luc_than_the];
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[2], ket_qua: "Trung b√¨nh", luan_giai: createExpandableSection(`H√†o ${G.the_hao} l√† <b>${G.luc_than_the}</b>: ${lucThanTheTraCuu ? lucThanTheTraCuu.the_ngan : '...'}`, lucThanTheTraCuu ? lucThanTheTraCuu.the_dai : '') });
        // Ti√™u ch√≠ 4: H√†o ƒê·ªông
        const haoDongDetailText = G.lines_detail[6 - hao_dong] || "";
        const lucThanDong = haoDongDetailText.split(/[-‚Äì]/)[0].trim();
        const lucThanDongTraCuu = ALL_DATA.lucThan[lucThanDong];
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[3], ket_qua: "Trung b√¨nh", luan_giai: createExpandableSection(`H√†o ${hao_dong} l√† <b>${haoDongDetailText}</b>: ${lucThanDongTraCuu ? lucThanDongTraCuu.dong_ngan : '...'}`, lucThanDongTraCuu ? lucThanDongTraCuu.dong_dai : '') });
        // Ti√™u ch√≠ 5: Qu·∫ª Th∆∞·ª£ng so v·ªõi Cung Phi
        const nguHanhCungPhi = cungPhiNguHanhMap[cungPhi];
        const queThuong = tienThienMap[qT_num] || { ten: 'N/A', hanh: null };
        const result5 = soSanhNguHanh(`Qu·∫ª Th∆∞·ª£ng ${queThuong.ten}`, queThuong.hanh, `Cung Phi ${cungPhi}`, nguHanhCungPhi);
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[4], ket_qua: result5.ket_qua, luan_giai: createExpandableSection(result5.luan_giai, '') });
        // Ti√™u ch√≠ 6: Qu·∫ª H·∫° so v·ªõi Cung Phi
        const queHa = tienThienMap[qH_num] || { ten: 'N/A', hanh: null };
        const result6 = soSanhNguHanh(`Qu·∫ª H·∫° ${queHa.ten}`, queHa.hanh, `Cung Phi ${cungPhi}`, nguHanhCungPhi);
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[5], ket_qua: result6.ket_qua, luan_giai: createExpandableSection(result6.luan_giai, '') });

        // Ti√™u ch√≠ 7: Ng≈© h√†nh d√£y s·ªë so v·ªõi cung phi
        const nguHanhDaySo = nguHanhDay_JS(sdt);
        const hanhCungPhi = cungPhiNguHanhMap[cungPhi];
        if(nguHanhDaySo && hanhCungPhi) { // Ki·ªÉm tra c·∫£ hai gi√° tr·ªã c√≥ t·ªìn t·∫°i
            const resultNguHanhDay = soSanhNguHanh(`Ng≈© h√†nh D√£y s·ªë`, nguHanhDaySo, `Cung Phi`, hanhCungPhi);
            detailResults.push({
                tieu_chi: TIEU_CHI_LIST[6],
                ket_qua: resultNguHanhDay.ket_qua,
                luan_giai: createExpandableSection(resultNguHanhDay.luan_giai, '')
            });
        } else {
            detailResults.push({
                tieu_chi: TIEU_CHI_LIST[6],
                ket_qua: "Trung b√¨nh",
                luan_giai: createExpandableSection(`Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c Ng≈© h√†nh c·ªßa d√£y s·ªë ho·∫∑c Cung Phi ƒë·ªÉ so s√°nh.`, '')
            });
        }

        // Ti√™u ch√≠ 8: Qu·∫ª g·ªëc ph·ªëi Cung Phi (Du Ni√™n)
        const normalizedCungGoc = normalizeName(G.cung_goc);
        const normalizedCungPhi = normalizeName(cungPhi);
        const duNienKey = `${normalizedCungGoc}-${normalizedCungPhi}`;
        const duNienData = ALL_DATA.duNien[duNienKey] || { bat_bien: "N/A", cat_hung: "Trung b√¨nh", y_nghia: "Kh√¥ng c√≥ di·ªÖn gi·∫£i." };
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[7], ket_qua: duNienData.cat_hung, luan_giai: createExpandableSection(`H·ªç qu·∫ª <b>${G.cung_goc}</b> ph·ªëi Cung Phi <b>${cungPhi}</b> ƒë∆∞·ª£c <b>${duNienData.bat_bien}</b>.`, duNienData.y_nghia) });

        // Ti√™u ch√≠ 9: Qu·∫ª th∆∞·ª£ng so v·ªõi D·ª•ng th·∫ßn
        const dungThanArr = dung.split(',').map(item => normalizeName(item.trim())).filter(Boolean); // L·ªçc b·ªè gi√° tr·ªã r·ªóng
        let hoTro9 = false;
        let luanGiai9_ngan = `Qu·∫ª Th∆∞·ª£ng <b>${queThuong.ten} (${queThuong.hanh || 'Kh√¥ng r√µ'})</b> kh√¥ng h·ªó tr·ª£ cho D·ª•ng th·∫ßn (${dungThanArr.join(', ')}).`;
        let luanGiai9_dai = `D·ª•ng th·∫ßn ƒë∆∞·ª£c ch·ªçn l√†: ${dungThanArr.join(', ')}. `;

        if (dungThanArr.length > 0 && queThuong.hanh) {
            for (const dt of dungThanArr) {
                const hanhDungThan = cungPhiNguHanhMap[dt];
                if (!hanhDungThan) continue; // B·ªè qua n·∫øu kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ng≈© h√†nh c·ªßa d·ª•ng th·∫ßn

                if (queThuong.hanh === hanhDungThan) {
                    luanGiai9_ngan = `Qu·∫ª Th∆∞·ª£ng <b>${queThuong.ten} (${queThuong.hanh})</b> T·ª∑ h√≤a v·ªõi D·ª•ng th·∫ßn <b>${dt} (${hanhDungThan})</b>.`;
                    luanGiai9_dai += `Hai y·∫øu t·ªë n√†y t·ª∑ h√≤a, r·∫•t t·ªët cho s·ª± c√¢n b·∫±ng v√† ·ªïn ƒë·ªãnh.`;
                    hoTro9 = true; break;
                } else if (nguHanhRelations[queThuong.hanh]?.sinh === hanhDungThan) {
                    luanGiai9_ngan = `Qu·∫ª Th∆∞·ª£ng <b>${queThuong.ten} (${queThuong.hanh})</b> T∆∞∆°ng Sinh cho D·ª•ng th·∫ßn <b>${dt} (${hanhDungThan})</b>.`;
                    luanGiai9_dai += `Qu·∫ª Th∆∞·ª£ng l√† ${queThuong.hanh}, t∆∞∆°ng sinh v·ªõi D·ª•ng th·∫ßn ${dt} (${hanhDungThan}). ƒêi·ªÅu n√†y mang l·∫°i s·ª± h·ªó tr·ª£ m·∫°nh m·∫Ω, ph√°t tri·ªÉn thu·∫≠n l·ª£i.`;
                    hoTro9 = true; break;
                } else if (nguHanhRelations[hanhDungThan]?.sinh === queThuong.hanh) {
                    luanGiai9_ngan = `D·ª•ng th·∫ßn <b>${dt} (${hanhDungThan})</b> Sinh Xu·∫•t cho Qu·∫ª Th∆∞·ª£ng <b>${queThuong.ten} (${queThuong.hanh})</b>.`;
                    luanGiai9_dai += `Qu·∫ª Th∆∞·ª£ng b·ªã Sinh Xu·∫•t b·ªüi D·ª•ng th·∫ßn. C√≥ th·ªÉ ti√™u hao nƒÉng l∆∞·ª£ng c·ªßa D·ª•ng th·∫ßn, c·∫ßn c√¢n nh·∫Øc.`;
                    hoTro9 = true; break; // V·∫´n coi l√† "h·ªó tr·ª£" nh∆∞ng ·ªü m·ª©c ƒë·ªô b√¨nh th∆∞·ªùng
                } else if (nguHanhRelations[queThuong.hanh]?.khac === hanhDungThan) {
                    luanGiai9_ngan = `Qu·∫ª Th∆∞·ª£ng <b>${queThuong.ten} (${queThuong.hanh})</b> T∆∞∆°ng Kh·∫Øc D·ª•ng th·∫ßn <b>${dt} (${hanhDungThan})</b>.`;
                    luanGiai9_dai += `Qu·∫ª Th∆∞·ª£ng kh·∫Øc D·ª•ng th·∫ßn. C√≥ th·ªÉ g√¢y c·∫£n tr·ªü, xung ƒë·ªôt ho·∫∑c kh√≥ khƒÉn trong qu√° tr√¨nh th·ª±c hi·ªán m·ª•c ti√™u.`;
                    hoTro9 = false; break;
                } else if (nguHanhRelations[hanhDungThan]?.khac === queThuong.hanh) {
                    luanGiai9_ngan = `D·ª•ng th·∫ßn <b>${dt} (${hanhDungThan})</b> kh·∫Øc Qu·∫ª Th∆∞·ª£ng <b>${queThuong.ten} (${queThuong.hanh})</b>.`;
                    luanGiai9_dai += `Qu·∫ª Th∆∞·ª£ng b·ªã D·ª•ng th·∫ßn kh·∫Øc. C√≥ th·ªÉ g·∫∑p kh√≥ khƒÉn ho·∫∑c b·ªã √°p ch·∫ø, c·∫ßn xem x√©t k·ªπ l∆∞·ª°ng.`;
                    hoTro9 = false; break;
                }
            }
        } else {
            luanGiai9_dai += `Kh√¥ng c√≥ D·ª•ng th·∫ßn h·ª£p l·ªá ho·∫∑c ng≈© h√†nh Qu·∫ª Th∆∞·ª£ng kh√¥ng r√µ ƒë·ªÉ so s√°nh.`;
        }
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[8], ket_qua: hoTro9 ? "T·ªët" : "Trung b√¨nh", luan_giai: createExpandableSection(luanGiai9_ngan, luanGiai9_dai) });

        // Ti√™u ch√≠ 10: Qu·∫ª h·∫° so v·ªõi D·ª•ng th·∫ßn
        let hoTro10 = false;
        let luanGiai10_ngan = `Qu·∫ª H·∫° <b>${queHa.ten} (${queHa.hanh || 'Kh√¥ng r√µ'})</b> kh√¥ng h·ªó tr·ª£ cho D·ª•ng th·∫ßn (${dungThanArr.join(', ')}).`;
        let luanGiai10_dai = `D·ª•ng th·∫ßn ƒë∆∞·ª£c ch·ªçn l√†: ${dungThanArr.join(', ')}. `;

        if (dungThanArr.length > 0 && queHa.hanh) {
            for (const dt of dungThanArr) {
                const hanhDungThan = cungPhiNguHanhMap[dt];
                if (!hanhDungThan) continue;

                if (queHa.hanh === hanhDungThan) {
                    luanGiai10_ngan = `Qu·∫ª H·∫° <b>${queHa.ten} (${queHa.hanh})</b> T·ª∑ h√≤a v·ªõi D·ª•ng th·∫ßn <b>${dt} (${hanhDungThan})</b>.`;
                    luanGiai10_dai += `Hai y·∫øu t·ªë n√†y t·ª∑ h√≤a, r·∫•t t·ªët cho s·ª± c√¢n b·∫±ng v√† ·ªïn ƒë·ªãnh.`;
                    hoTro10 = true; break;
                } else if (nguHanhRelations[queHa.hanh]?.sinh === hanhDungThan) {
                    luanGiai10_ngan = `Qu·∫ª H·∫° <b>${queHa.ten} (${queHa.hanh})</b> T∆∞∆°ng Sinh cho D·ª•ng th·∫ßn <b>${dt} (${hanhDungThan})</b>.`;
                    luanGiai10_dai += `Qu·∫ª H·∫° l√† ${queHa.hanh}, t∆∞∆°ng sinh v·ªõi D·ª•ng th·∫ßn ${dt} (${hanhDungThan}). ƒêi·ªÅu n√†y mang l·∫°i s·ª± h·ªó tr·ª£ m·∫°nh m·∫Ω, gi√∫p m·ªçi vi·ªác hanh th√¥ng.`;
                    hoTro10 = true; break;
                } else if (nguHanhRelations[hanhDungThan]?.sinh === queHa.hanh) {
                    luanGiai10_ngan = `D·ª•ng th·∫ßn <b>${dt} (${hanhDungThan})</b> Sinh Xu·∫•t cho Qu·∫ª H·∫° <b>${queHa.ten} (${queHa.hanh})</b>.`;
                    luanGiai10_dai += `Qu·∫ª H·∫° b·ªã Sinh Xu·∫•t b·ªüi D·ª•ng th·∫ßn. C√≥ th·ªÉ ti√™u hao nƒÉng l∆∞·ª£ng c·ªßa D·ª•ng th·∫ßn, c·∫ßn c√¢n nh·∫Øc.`;
                    hoTro10 = true; break;
                } else if (nguHanhRelations[queHa.hanh]?.khac === hanhDungThan) {
                    luanGiai10_ngan = `Qu·∫ª H·∫° <b>${queHa.ten} (${queHa.hanh})</b> T∆∞∆°ng Kh·∫Øc D·ª•ng th·∫ßn <b>${dt} (${hanhDungThan})</b>.`;
                    luanGiai10_dai += `Qu·∫ª H·∫° kh·∫Øc D·ª•ng th·∫ßn. C√≥ th·ªÉ g√¢y c·∫£n tr·ªü, xung ƒë·ªôt ho·∫∑c kh√≥ khƒÉn trong qu√° tr√¨nh th·ª±c hi·ªán m·ª•c ti√™u.`;
                    hoTro10 = false; break;
                } else if (nguHanhRelations[hanhDungThan]?.khac === queHa.hanh) {
                    luanGiai10_ngan = `D·ª•ng th·∫ßn <b>${dt} (${hanhDungThan})</b> kh·∫Øc Qu·∫ª H·∫° <b>${queHa.ten} (${queHa.hanh})</b>.`;
                    luanGiai10_dai += `Qu·∫ª H·∫° b·ªã D·ª•ng th·∫ßn kh·∫Øc. C√≥ th·ªÉ g·∫∑p kh√≥ khƒÉn ho·∫∑c b·ªã √°p ch·∫ø, c·∫ßn xem x√©t k·ªπ l∆∞·ª°ng.`;
                    hoTro10 = false; break;
                }
            }
        } else {
            luanGiai10_dai += `Kh√¥ng c√≥ D·ª•ng th·∫ßn h·ª£p l·ªá ho·∫∑c ng≈© h√†nh Qu·∫ª H·∫° kh√¥ng r√µ ƒë·ªÉ so s√°nh.`;
        }
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[9], ket_qua: hoTro10 ? "T·ªët" : "Trung b√¨nh", luan_giai: createExpandableSection(luanGiai10_ngan, luanGiai10_dai) });

        // Ti√™u ch√≠ 11: 2 s·ªë cu·ªëi t·∫°o th√†nh qu·∫ª d·ªãch
        const haiSoCuoi = sdt.slice(-2);
        const traCuuHaiSoCuoi = ALL_DATA.capSo?.[haiSoCuoi];
        let luanGiai11_ngan = `Kh√¥ng t√¨m th·∫•y th√¥ng tin cho c·∫∑p s·ªë cu·ªëi <b>${haiSoCuoi}</b>.`;
        let luanGiai11_dai = '';
        if (traCuuHaiSoCuoi) {
            luanGiai11_ngan = `2 s·ªë cu·ªëi <b>${haiSoCuoi}</b> t·∫°o th√†nh qu·∫ª <b>${traCuuHaiSoCuoi.ten_que} (${traCuuHaiSoCuoi.tot_xau || "TB"})</b>. √ù nghƒ©a: ${traCuuHaiSoCuoi.y_nghia}`;
            luanGiai11_dai = traCuuHaiSoCuoi.y_nghia; // Chi ti·∫øt h∆°n c√≥ th·ªÉ l·∫•y t·ª´ ƒë√¢y n·∫øu c√≥
        }
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[10], ket_qua: traCuuHaiSoCuoi ? (traCuuHaiSoCuoi.tot_xau || "Trung b√¨nh") : "Trung b√¨nh", luan_giai: createExpandableSection(luanGiai11_ngan, luanGiai11_dai) });

        // Ti√™u ch√≠ 12: C√°c c·∫∑p s·ªë h√†nh tr√¨nh
        // L·∫•y 6 s·ªë cu·ªëi n·∫øu SƒêT d√†i h∆°n 6, n·∫øu kh√¥ng th√¨ l·∫•y to√†n b·ªô
        const hanhTrinhSdt = sdt.length > 6 ? sdt.slice(-6) : sdt;
        // T√°ch th√†nh c√°c c·∫∑p s·ªë (v√≠ d·ª•: "123456" -> ["12", "34", "56"])
        const capHanhTrinh = (hanhTrinhSdt.match(/.{1,2}/g) || []).filter(c => c.length === 2); // ƒê·∫£m b·∫£o l√† c·∫∑p 2 s·ªë

        let cacQueHanhTrinhHtml = '';
        if (capHanhTrinh.length > 0) {
            cacQueHanhTrinhHtml += `<p>C√°c qu·∫ª h√†nh tr√¨nh t·ª´ ${Math.min(sdt.length, 6)} s·ªë cu·ªëi c·ªßa d√£y s·ªë <b>${hanhTrinhSdt}</b> l√†:</p><ul>`;
            capHanhTrinh.forEach(cap => {
                const que = ALL_DATA.capSo?.[cap];
                if (que) {
                    cacQueHanhTrinhHtml += `<li><b>${cap}</b> ‚Üí ${que.ten_que} (${que.tot_xau || 'TB'}): ${que.y_nghia}</li>`;
                } else {
                    cacQueHanhTrinhHtml += `<li><b>${cap}</b> ‚Üí Kh√¥ng t√¨m th·∫•y th√¥ng tin.</li>`;
                }
            });
            cacQueHanhTrinhHtml += `</ul>`;
        } else {
            cacQueHanhTrinhHtml = 'Kh√¥ng t√¨m th·∫•y ƒë·ªß c·∫∑p s·ªë h√†nh tr√¨nh (y√™u c·∫ßu √≠t nh·∫•t 2 s·ªë).';
        }
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[11], ket_qua: "Trung b√¨nh", luan_giai: createExpandableSection(cacQueHanhTrinhHtml, '') });

        // Ti√™u ch√≠ 13: C√¢n b·∫±ng √¢m d∆∞∆°ng
        const amDuongResult = luanAmDuong(sdt, y);
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[12], ket_qua: amDuongResult.ket_qua, luan_giai: createExpandableSection(amDuongResult.luan_giai, '') });
        // Ti√™u ch√≠ 14: D√£y s·ªë theo ƒë∆∞∆°ng v·∫≠n
        const duongVanResult = luanDuongVan(sdt);
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[13], ket_qua: duongVanResult.ket_qua, luan_giai: createExpandableSection(duongVanResult.luan_giai, '') });
        // Ti√™u ch√≠ 15: C√°c c·∫∑p c√°t hung theo th·∫ßn s·ªë & nƒÉng l∆∞·ª£ng
        const thanSoResult = luanThanSo(sdt, ALL_DATA.nangLuong); // H√†m n√†y gi·ªù tr·∫£ v·ªÅ HTML chi ti·∫øt
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[14], ket_qua: thanSoResult.ket_qua, luan_giai: thanSoResult.luan_giai });

        // Ti√™u ch√≠ 16: T·ªï h·ª£p ƒë·∫∑c bi·ªát 3 s·ªë cu·ªëi (kh√¥ng l·∫∑p)
        const baSoCuoiKhongLap = capKhongLap_JS(sdt);
        const traCuuBaSoCuoi = ALL_DATA.toHop?.[baSoCuoiKhongLap];
        let luanGiai16_ngan = `Kh√¥ng t√¨m th·∫•y t·ªï h·ª£p 3 s·ªë cu·ªëi (kh√¥ng l·∫∑p) ƒë·∫∑c bi·ªát n√†o trong d√£y s·ªë.`;
        let luanGiai16_dai = '';
        let ketQua16 = "Trung b√¨nh";
        if (traCuuBaSoCuoi) {
            luanGiai16_ngan = `3 s·ªë cu·ªëi (kh√¥ng l·∫∑p) l√† <b>${baSoCuoiKhongLap}</b> (${traCuuBaSoCuoi.ten_goi}) >> ${traCuuBaSoCuoi.y_nghia_ngan}`;
            luanGiai16_dai = traCuuBaSoCuoi.y_nghia_dai;
            ketQua16 = "T·ªët"; // Coi l√† t·ªët n·∫øu t√¨m th·∫•y t·ªï h·ª£p ƒë·∫∑c bi·ªát
        }
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[15], ket_qua: ketQua16, luan_giai: createExpandableSection(luanGiai16_ngan, luanGiai16_dai) });

        // Ti√™u ch√≠ 17: C√°c t·ªï h·ª£p s·ªë ƒë·∫∑c bi·ªát
        const foundSpecialCombos = luanToHopDacBiet(sdt, ALL_DATA.toHop);
        let specialComboHtml = '';
        let ketQua17 = "Trung b√¨nh";

        if (foundSpecialCombos.length > 0) {
            ketQua17 = "T·ªët";
            foundSpecialCombos.forEach(comboKey => {
                const toHopData = ALL_DATA.toHop[comboKey];
                if (toHopData) {
                    const summary = `<b>${comboKey}</b> (${toHopData.ten_goi}) ‚Äì ${toHopData.y_nghia_ngan}`;
                    specialComboHtml += createExpandableSection(summary, toHopData.y_nghia_dai);
                } else {
                    specialComboHtml += createExpandableSection(`<b>${comboKey}</b>: Kh√¥ng c√≥ d·ªØ li·ªáu lu·∫≠n gi·∫£i chi ti·∫øt t·ª´ ngu·ªìn.`, '');
                }
            });
            specialComboHtml = `C√≥ ${foundSpecialCombos.length} t·ªï h·ª£p s·ªë ƒë·∫∑c bi·ªát ƒë∆∞·ª£c t√¨m th·∫•y:<br>` + specialComboHtml;
        } else {
            specialComboHtml = "Kh√¥ng t√¨m th·∫•y t·ªï h·ª£p 3 s·ªë li√™n ti·∫øp ƒë·∫∑c bi·ªát n√†o trong d√£y s·ªë (tr·ª´ c√°c t·ªï h·ª£p b·∫Øt ƒë·∫ßu b·∫±ng 0).";
        }
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[16], ket_qua: ketQua17, luan_giai: specialComboHtml });

        // Ti√™u ch√≠ 18: T·ªï h·ª£p s·ªë 0&5 ( s·ª≠a th√†nh ghi ch√∫)
        let combo05ResultsHtml = '';
        let ketQua18 = "Trung b√¨nh";

        // Regex: (ch·ªØ s·ªë kh√¥ng ph·∫£i 0/5) + (m·ªôt ho·∫∑c nhi·ªÅu 0/5) + (ch·ªØ s·ªë kh√¥ng ph·∫£i 0/5)
        // D√πng global flag ƒë·ªÉ t√¨m t·∫•t c·∫£ c√°c kh·ªõp
        const regex05 = /(\d)[05]+(\d)/g;
        let match;
        let foundAny05Combo = false;

        // Reset lastIndex c·ªßa regex n·∫øu n√≥ ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng tr∆∞·ªõc ƒë√≥
        regex05.lastIndex = 0;

        while ((match = regex05.exec(sdt)) !== null) {
            const fullMatch = match[0]; // V√≠ d·ª•: "108", "253"
            const firstDigit = match[1]; // V√≠ d·ª•: "1", "2"
            const lastDigit = match[2]; // V√≠ d·ª•: "8", "3"

            // ƒê·∫£m b·∫£o k√Ω t·ª± ƒë·∫ßu v√† cu·ªëi kh√¥ng ph·∫£i l√† '0' ho·∫∑c '5'
            if (firstDigit !== '0' && firstDigit !== '5' && lastDigit !== '0' && lastDigit !== '5') {
                const toHopData = ALL_DATA.toHop?.[fullMatch];
                if (toHopData) {
                    const summary = `T·ªï h·ª£p <b>${fullMatch}</b> (${toHopData.ten_goi}) ‚Äì ${toHopData.y_nghia_ngan}`;
                    combo05ResultsHtml += createExpandableSection(summary, toHopData.y_nghia_dai);
                    foundAny05Combo = true;
                } else {
                    combo05ResultsHtml += createExpandableSection(`T·ªï h·ª£p <b>${fullMatch}</b>: Kh√¥ng c√≥ d·ªØ li·ªáu lu·∫≠n gi·∫£i chi ti·∫øt t·ª´ ngu·ªìn.`, '');
                    foundAny05Combo = true;
                }
            }
        }

        if (foundAny05Combo) {
            ketQua18 = "T·ªët"; // Coi l√† T·ªët n·∫øu t√¨m th·∫•y b·∫•t k·ª≥ t·ªï h·ª£p 0&5 h·ª£p l·ªá n√†o
            combo05ResultsHtml = `C√≥ c√°c t·ªï h·ª£p s·ªë 0&5 ƒë∆∞·ª£c t√¨m th·∫•y:<br>` + combo05ResultsHtml;
        } else {
            combo05ResultsHtml = "Kh√¥ng t√¨m th·∫•y t·ªï h·ª£p s·ªë 0&5 n√†o theo quy t·∫Øc (k√Ω t·ª± ƒë·∫ßu v√† cu·ªëi kh√¥ng ph·∫£i 0/5, ·ªü gi·ªØa c√≥ 0 ho·∫∑c 5).";
        }
        detailResults.push({ tieu_chi: TIEU_CHI_LIST[17], ket_qua: ketQua18, luan_giai: combo05ResultsHtml });


        buildDetail(detailResults); // X√¢y d·ª±ng b·∫£ng chi ti·∫øt tr√™n Tab 2
        FINAL_RESULTS = detailResults.map(item => ({
            tieu_chi: item.tieu_chi,
            // Kh·ªüi t·∫°o cham_diem m·∫∑c ƒë·ªãnh: 5 cho T·ªët, 1 cho X·∫•u, 3 cho Trung b√¨nh
            cham_diem: item.ket_qua === 'T·ªët' ? 5 : (item.ket_qua === 'X·∫•u' ? 1 : 3),
            ket_qua: item.ket_qua,
            luan_cu: item.luan_giai // Ban ƒë·∫ßu l·∫•y luan_giai t·ª´ detailResults, s·∫Ω ƒë∆∞·ª£c s·ª≠a khi ng∆∞·ªùi d√πng nh·∫≠p
        }));

        renderTab3Filters(); // Render l·∫°i b·ªô l·ªçc v√† b√°o c√°o tr√™n Tab 3

    } catch (e) {
        alert("L·ªói trong qu√° tr√¨nh lu·∫≠n gi·∫£i: " + e.message);
        console.error("L·ªói trong h√†m run():", e);
    }
}
// --- KH·ªûI ƒê·ªòNG V√Ä X·ª¨ L√ù TAB ---
/**
 * @function layDuLieuPhongThuy
 * @description H√†m kh·ªüi ƒë·ªông ·ª©ng d·ª•ng, ƒë∆∞·ª£c g·ªçi khi trang web t·∫£i xong.
 * T·∫£i d·ªØ li·ªáu phong th·ªßy t·ª´ Google Sheet (backend) th√¥ng qua Apps Script.
 * @returns {void}
 */
google.script.run
    .withSuccessHandler(res => {
        // ·∫®n m√†n h√¨nh loading v√† hi·ªÉn th·ªã n·ªôi dung ch√≠nh
        document.getElementById('app-loader').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        if (!res.success) {
            // Hi·ªÉn th·ªã l·ªói n·∫øu t·∫£i d·ªØ li·ªáu kh√¥ng th√†nh c√¥ng
            document.body.innerHTML = `<p style="color:red; text-align:center; padding: 50px;">‚ùå L·ªói T·∫£i D·ªØ Li·ªáu: ${res.error}. Vui l√≤ng ki·ªÉm tra l·∫°i Google Sheet v√† th·ª≠ l·∫°i.</p>`;
            return;
        }
        ALL_DATA = res; // L∆∞u tr·ªØ d·ªØ li·ªáu ƒë√£ t·∫£i v√†o bi·∫øn to√†n c·ª•c
        run(); // Ch·∫°y h√†m lu·∫≠n gi·∫£i ch√≠nh ngay sau khi t·∫£i d·ªØ li·ªáu
    })
    .withFailureHandler(err => {
        // X·ª≠ l√Ω l·ªói n·∫øu c√≥ v·∫•n ƒë·ªÅ khi giao ti·∫øp v·ªõi Apps Script backend
        alert("L·ªñI K·∫æT N·ªêI SERVER: " + err.message);
        console.error("L·ªñI BACKEND:", err);
        document.getElementById('app-loader').innerHTML = `<span>‚ùå L·ªói kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.</span>`;
        document.getElementById('app-loader').style.color = 'red';
    })
    .layDuLieuPhongThuy(); // G·ªçi h√†m Apps Script ƒë·ªÉ l·∫•y d·ªØ li·ªáu

/**
 * @event DOMContentLoaded
 * @description L·∫Øng nghe s·ª± ki·ªán click tr√™n c√°c n√∫t tab ƒë·ªÉ chuy·ªÉn ƒë·ªïi gi·ªØa c√°c tab.
 */
document.querySelectorAll('.tabs button').forEach(button => {
    button.addEventListener('click', () => {
        // X√≥a l·ªõp 'active' kh·ªèi t·∫•t c·∫£ c√°c n√∫t tab v√† ·∫©n t·∫•t c·∫£ c√°c tab content
        document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(tab => tab.style.display = 'none');
        // Th√™m l·ªõp 'active' cho n√∫t ƒë∆∞·ª£c click v√† hi·ªÉn th·ªã tab content t∆∞∆°ng ·ª©ng
        button.classList.add('active');
        document.getElementById(button.dataset.tab).style.display = 'block';

        // N·∫øu chuy·ªÉn sang Tab 3, render l·∫°i b·ªô l·ªçc v√† b√°o c√°o
        if (button.dataset.tab === 't3') {
            renderTab3Filters();
        }
    });
});
</script>
</body>
</html>