<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√¨m D√£y S·ªë Phong Th·ªßy (v3 - Xu·∫•t Excel)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #0056b3; --secondary-color: #1a73e8; --background-color: #f0f2f5;
            --card-background: #ffffff; --text-color: #333; --border-radius: 8px;
            --box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color); color: var(--text-color); margin: 0;
            padding: 15px; display: flex; justify-content: center;
        }
        .container { max-width: 600px; width: 100%; }
        h1 { color: var(--primary-color); text-align: center; margin-bottom: 20px; font-size: 24px;}
        .card { background-color: var(--card-background); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        .input-group input { width: calc(100% - 22px); padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 16px; }
        .button-group { margin-top: 20px; display: flex; gap: 10px; }
        .btn { flex-grow: 1; padding: 12px; border: none; border-radius: var(--border-radius); font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s ease-in-out; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: #17a2b8; color: white; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        #status-text { text-align: center; margin-top: 15px; font-weight: bold; color: #d9534f; }
        #results-area { margin-top: 15px; background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: var(--border-radius); overflow-x: auto; font-family: "Consolas", "Menlo", monospace; font-size: 14px; white-space: pre; min-height: 100px;}
    </style>
</head>
<body>

<div class="container">
    <h1>T√¨m D√£y S·ªë Phong Th·ªßy (v3)</h1>
    
    <div class="card">
        <div class="input-group">
            <label for="total_len">üî¢ ƒê·ªô d√†i chu·ªói (2-15):</label>
            <input type="number" id="total_len" value="6" min="2" max="15">
        </div>
        <div class="input-group">
            <label for="fix_A">üî† C·ªë ƒë·ªãnh ƒë·∫ßu A (vd: 09):</label>
            <input type="text" id="fix_A" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥">
        </div>
        <div class="input-group">
            <label for="fix_B">üî° C·ªë ƒë·ªãnh ƒëu√¥i B (vd: 86):</label>
            <input type="text" id="fix_B" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥">
        </div>
        <div class="input-group">
            <label for="x">‚òØÔ∏è Qu·∫ª Th∆∞·ª£ng (x, 0-8):</label>
            <input type="number" id="x" placeholder="Nh·∫≠p s·ªë t·ª´ 0 ƒë·∫øn 8" min="0" max="8">
        </div>
        <div class="input-group">
            <label for="y">‚òØÔ∏è Qu·∫ª H·∫° (y, 0-8):</label>
            <input type="number" id="y" placeholder="Nh·∫≠p s·ªë t·ª´ 0 ƒë·∫øn 8" min="0" max="8">
        </div>
        <div class="input-group">
            <label for="z">‚ö° H√†o ƒê·ªông (z, 0-6):</label>
            <input type="number" id="z" placeholder="Nh·∫≠p s·ªë t·ª´ 0 ƒë·∫øn 6" min="0" max="6">
        </div>
    </div>

    <div class="button-group">
        <button id="btn-timkiem" class="btn btn-primary">‚ñ∂Ô∏è Th·ª±c Hi·ªán</button>
        <button id="btn-xuat" class="btn btn-secondary" disabled>üìÑ Xu·∫•t Excel (.xlsx)</button>
    </div>
    
    <p id="status-text"></p>
    <div id="results-area">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</div>
</div>

<script>
    const totalLenEl = document.getElementById('total_len');
    const fixAEl = document.getElementById('fix_A');
    const fixBEl = document.getElementById('fix_B');
    const xEl = document.getElementById('x');
    const yEl = document.getElementById('y');
    const zEl = document.getElementById('z');
    const findBtn = document.getElementById('btn-timkiem');
    const exportBtn = document.getElementById('btn-xuat');
    const statusText = document.getElementById('status-text');
    const resultsArea = document.getElementById('results-area');
    let lastResults = [];

    findBtn.addEventListener('click', () => {
        findBtn.disabled = true;
        exportBtn.disabled = true;
        resultsArea.textContent = 'ƒêang x·ª≠ l√Ω, vui l√≤ng ch·ªù...';
        statusText.textContent = '';
        lastResults = [];

        setTimeout(() => {
            try {
                runSearch();
            } catch (e) {
                statusText.textContent = 'L·ªói nghi√™m tr·ªçng: ' + e.message;
                resultsArea.textContent = 'ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng ki·ªÉm tra l·∫°i c√°c gi√° tr·ªã nh·∫≠p.';
            } finally {
                findBtn.disabled = false;
            }
        }, 50);
    });
    
    // === H√ÄM XU·∫§T EXCEL ƒê√É N√ÇNG C·∫§P ===
    exportBtn.addEventListener('click', () => {
        if (lastResults.length === 0) return;
        
        // 1. T·∫°o ti√™u ƒë·ªÅ
        const headers = ["D√£y g·ªëc", "Ph·∫ßn A", "T·ªïng A", "Ph·∫ßn B", "T·ªïng B", "T·ªïng A+B"];
        // 2. Th√™m ti√™u ƒë·ªÅ v√†o ƒë·∫ßu m·∫£ng d·ªØ li·ªáu
        const dataToExport = [headers, ...lastResults];
        
        // 3. T·∫°o m·ªôt trang t√≠nh (worksheet) t·ª´ m·∫£ng d·ªØ li·ªáu
        const ws = XLSX.utils.aoa_to_sheet(dataToExport);

        // 4. (T√πy ch·ªçn) ƒêi·ªÅu ch·ªânh ƒë·ªô r·ªông c·ªôt cho ƒë·∫πp
        ws['!cols'] = [
            { wch: 15 }, // D√£y g·ªëc
            { wch: 15 }, // Ph·∫ßn A
            { wch: 8 },  // T·ªïng A
            { wch: 15 }, // Ph·∫ßn B
            { wch: 8 },  // T·ªïng B
            { wch: 10 }  // T·ªïng A+B
        ];
        
        // 5. T·∫°o m·ªôt s·ªï l√†m vi·ªác (workbook) m·ªõi v√† th√™m trang t√≠nh v√†o
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "KetQua");
        
        // 6. Xu·∫•t file Excel v·ªõi t√™n ƒë∆∞·ª£c ƒë·ªãnh s·∫µn
        XLSX.writeFile(wb, "KetQua_TimSoPhongThuy.xlsx");
    });

    function sumDigits(s) {
        let sum = 0;
        for (let i = 0; i < s.length; i++) {
            sum += parseInt(s[i], 10);
        }
        return sum;
    }

    function generateValidParts(length, prefix_suffix, target_mod_val, is_suffix) {
        const valid_parts = [];
        const fixed_len = prefix_suffix.length;
        const remaining_length = length - fixed_len;

        if (remaining_length < 0) return [];
        if (remaining_length === 0) {
            const sum_fixed = sumDigits(prefix_suffix);
            if (sum_fixed % 8 === target_mod_val % 8) {
                valid_parts.push({ str: prefix_suffix, sum: sum_fixed });
            }
            return valid_parts;
        }
        
        const sum_fixed_part = sumDigits(prefix_suffix);
        const max_i = Math.pow(10, remaining_length);

        for (let i = 0; i < max_i; i++) {
            const remaining_str = i.toString().padStart(remaining_length, '0');
            const current_sum = sumDigits(remaining_str) + sum_fixed_part;
            if (current_sum % 8 === target_mod_val % 8) {
                const final_str = is_suffix ? remaining_str + prefix_suffix : prefix_suffix + remaining_str;
                valid_parts.push({ str: final_str, sum: current_sum });
            }
        }
        return valid_parts;
    }

    function runSearch() {
        const total_len = parseInt(totalLenEl.value, 10);
        const fix_A = fixAEl.value.replace(/\s/g, '');
        const fix_B = fixBEl.value.replace(/\s/g, '');
        const x = parseInt(xEl.value || '0', 10);
        const y = parseInt(yEl.value || '0', 10);
        const z = parseInt(zEl.value || '0', 10);

        if (total_len > 10) {
            statusText.textContent = `C·∫¢NH B√ÅO: ƒê·ªô d√†i ${total_len} s·∫Ω ch·∫°y R·∫§T L√ÇU v√† c√≥ th·ªÉ l√†m treo tr√¨nh duy·ªát!`;
            if (!confirm(`ƒê·ªô d√†i chu·ªói ${total_len} c√≥ th·ªÉ m·∫•t h√†ng ph√∫t ho·∫∑c l√†m treo tr√¨nh duy·ªát. S·∫øp c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c kh√¥ng?`)) {
                 resultsArea.textContent = 'ƒê√£ h·ªßy.';
                 statusText.textContent = '';
                 return;
            }
        }

        const len_A = Math.floor(total_len / 2);
        const len_B = total_len - len_A;

        if (fix_A.length > len_A || fix_B.length > len_B) {
            statusText.textContent = 'L·ªói: ƒê·ªô d√†i ph·∫ßn c·ªë ƒë·ªãnh l·ªõn h∆°n ƒë·ªô d√†i ph·∫ßn t∆∞∆°ng ·ª©ng.';
            return;
        }

        const valid_parts_A = generateValidParts(len_A, fix_A, x, false);
        const valid_parts_B = generateValidParts(len_B, fix_B, y, true);

        const kq = [];
        const seen_normalized_pairs = new Set();
        for (const partA of valid_parts_A) {
            for (const partB of valid_parts_B) {
                if ((partA.sum + partB.sum) % 6 === z % 6) {
                     const a_normalized = partA.str.split('').sort().join('');
                     const b_normalized = partB.str.split('').sort().join('');
                     const current_normalized_pair = `${a_normalized}|${b_normalized}`;
                     if (!seen_normalized_pairs.has(current_normalized_pair)) {
                        kq.push([partA.str + partB.str, partA.str, partA.sum, partB.str, partB.sum, partA.sum + partB.sum]);
                        seen_normalized_pairs.add(current_normalized_pair);
                     }
                }
            }
        }
        
        displayResults(kq);
    }
    
    function displayResults(kq) {
        statusText.textContent = `T√¨m th·∫•y ${kq.length} k·∫øt qu·∫£ ph√π h·ª£p (ƒë√£ l·ªçc ho√°n v·ªã).`;
        if (kq.length === 0) {
            resultsArea.textContent = 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o.';
            exportBtn.disabled = true;
            return;
        }

        lastResults = kq; // L∆∞u k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng m·∫£ng ƒë·ªÉ xu·∫•t excel
        let output = 'D√£y g·ªëc | Ph·∫ßn A (T·ªïng) | Ph·∫ßn B (T·ªïng) | T·ªïng A+B\n';
        output += '-'.repeat(60) + '\n';
        const displayLimit = 500;
        kq.slice(0, displayLimit).forEach(row => {
            output += `${row[0].padEnd(8)}| ${row[1].padEnd(6)} (${String(row[2]).padEnd(2)}) | ${row[3].padEnd(6)} (${String(row[4]).padEnd(2)}) | ${row[5]}\n`;
        });
        if(kq.length > displayLimit) {
            output += `\n... v√† ${kq.length - displayLimit} k·∫øt qu·∫£ kh√°c (xu·∫•t file Excel ƒë·ªÉ xem h·∫øt).`
        }

        resultsArea.textContent = output;
        exportBtn.disabled = false;
    }
</script>

</body>
</html>